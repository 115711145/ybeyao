<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link type="text/css" rel="stylesheet" href="../css/mui.min.css" />
		<link type="text/css" rel="stylesheet" href="../css/own.css" />
		<link type="text/css" rel="stylesheet" href="../css/iconfont/iconfont.css" />
		<link type="text/css" rel="stylesheet" href="../css/icons-extra.css" />
		<link type="text/css" rel="stylesheet" href="../css/order-detail.css" />
	</head>
	<body>
		<header class="mui-bar mui-bar-nav own-main-background-color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="back"></a>
			<h1 class="mui-title" id="header-title">订单详情</h1>
		</header>
		<div class="loader" id="loader">
			<a>
				<span class="mui-spinner"></span>
			</a>
			<br />
			<span>加载中...</span>
		</div>
		<div class="mui-content" id="no-order" style="display: none;">
			<div id="no-content">
				<p><img src="../images/kuqi.png" /></p>
				<p>很抱歉,订单不存在</p>
			</div>
		</div>
		<div class="mui-content" id="order" style="display: none;">
			<div class="user-address" id="address">
				<!--<p>
					<span class="name">收货人：张三</span>
					<span class="phone">电话：15012345678</span>
				</p>
				<p class="address">
					收件地址：江
				</p>
				<p class="icon">
					<span class="mui-icon mui-icon-arrowright"></span>
				</p>-->
			</div>
			<ul class="sc_list" id="goods-list">
				<li>
	                <div class="goods-img fl">
	                	<img src="http://ybuser.ybyiyao.com/public/upload/goods/thumb/3580/goods_thumb_3580_200_200.jpeg">
	                </div>
	                <div class="goods-info fl">
	                    <p class="title">
	                    	云南白药 气血康胶囊24粒（买五送一送原品）
	                    </p>
	                    <p class="weight">套餐:套餐一 买赠:买赠一</p>
	                </div>
	                <div class="price-num fr">
	                	 <p class="price">
	                        <span>￥</span><span>10001.00</span>
	                	</p>
	                	<p>
	                		<span>×</span><span>1100</span>
	                	</p>
	                </div>
		        </li>
	       </ul>
	       <div class="amout-list">
	       		<p class="bold-title">基本信息</p>
	       		<p><span class="title">订单编号</span><span id="goods_sn"></span></p>
	       		<p><span class="title">订单状态</span><span id="status"></span></p>
	       		<p style="display: none;"><span class="title">退款状态</span><span id="return-status"></span></p>
	       		<p><span class="title">下单时间</span><span id="add_time"></span></p>
	       		<div id="times">
		       		<p><span class="title">支付时间</span><span></span></p>
		       		<p><span class="title">发货时间</span><span></span></p>
		       		<p><span class="title">确认收货</span><span></span></p>
	       		</div>
	       		<p><span class="title">支付方式</span><span id="pay_name"></span></p>
	       		<p><span class="title">配送方式</span><span id="shipping_name"></span></p>
	       		<p style="display: none;"><span class="title">自取门店</span><span id="shop_name"></span></p>
	       		<p><span class="title">买家留言</span><span></span></p>
	       		<p id="note"></p>
	       </div>
	       <div class="amout-list">
	       		<p class="bold-title">价格信息</p>
	       		<p><span class="title">商品金额</span><span id="sum_amount">￥0</span></p>
	       		<p><span class="title">配送费用</span><span id="sum_ps">￥0</span></p>
	       		<p><span class="title">余额抵扣</span><span id="blance">-￥0</span></p>
	       		<p><span class="title">积分抵扣</span><span id="point">-￥0</span></p>
	       		<!--<p><span class="title">折扣优惠:</span><span id="discount">-￥0</span></p>-->
	       		<p><span class="title">优&nbsp;&nbsp;惠&nbsp;&nbsp;券</span><span id="coupon">-￥0</span></p>
	       		<p><span class="title" id="pay-title">应付金额</span><span class="price" id="order_amount">￥0</span></p>
		       	<div class="btns" id="btns"></div>
	       </div>
		</div>
		<div id="delete" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="del">
					<a href="#delete" style="color: #FF3B30;">删除订单</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#delete" style="color: #999;">取消</a>
				</li>
			</ul>
		</div>
		<div id="cansel" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="cansel_order">
					<a href="#cansel" style="color: #FF3B30;">取消订单</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#cansel" style="color: #999;">取消</a>
				</li>
			</ul>
		</div>
		<div id="pay_list" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" type="weixin" >
					<a style="color:#999">选择支付方式</a>
				</li>
				<li class="mui-table-view-cell pay" type="wxpay" >
					<a href="#pay_list" ><span class="mui-icon mui-icon-weixin" style="color:#41CEA9;margin-right:5px ;"></span>微信支付</a>
				</li>
				<li class="mui-table-view-cell pay" type="alipay">
					<a href="#pay_list" ><span class="mui-icon-extra mui-icon-extra-alipay" style="font-size: 20px;"></span>
						支付宝支付</a>
				</li>
				<!--<li class="mui-table-view-cell" type="hdfk">
					<a href="#" >货到付款</a>
				</li>-->
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" type="cansel">
					<a href="#pay_list" style="color: #999;" >取消</a>
				</li>
			</ul>
		</div>
    <script type="text/javascript" src="../js/mui.min.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/common.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/city.js" charset="UTF-8"></script>
    <script type="text/javascript">
    	(function(win, d, $, h, ms) {
			$.init();
			h.d={
				address:d.getElementById('address'),
				loader:d.getElementById('loader'),
				shop_name:d.getElementById('shop_name'),
				blance:d.getElementById('blance'),
				point:d.getElementById('point'),
				coupon:d.getElementById('coupon'),
				order_amount:d.getElementById('order_amount')
//				return_status:d.getElementById('return-status')
			}
			h.getOrderDetail=function(w){
				if(!h.order_id>0){
					h.noContent()
					return
				}
				$.ajax(h.apiurl,{
					type:"post",
					async:true,
					dataType:'json',
					data:{
						m:'order_detail',
						token:h.token,
						id:h.order_id
					},
					success:function(ret){
						if(w){
							w.close();
							w=null;
						}
						if(ret.code==0){
							h.d.loader.style.display="none";
			        		d.getElementById('order').style.display="block";
							h.data=ret.data;
							//收货地址
							h.d.address.innerHTML='<div class="user"><p><span class="name">收货人：'+ret.data.consignee+'</span>\
							<span class="phone">电话：'+ret.data.mobile+'</span></p><p class="address">\
							收件地址：'+ret.data.address+'</p></div>';
							//商品列表
							var html=[];
							$.each(ret.data.goods_list, function(i,v) {
								var img=h.apihost+'/public/upload/goods/thumb/'+v.goods_id+'/goods_sub_thumb_'+v.img_id+'_150_150.jpg';
								var cls='';
								if(v.return_status>2&&v.return_status<5){
									cls=' class="is-return" ';
									v.goods_name='<font color="red">[已退]</font>'+v.goods_name;
								}
								html.push('<li '+cls+'goods_id="'+v.goods_id+'"><div class="goods-img fl"><img src="'+img+'" onerror="javascript:this.src=\'../images/default.png\'"/></div><div class="goods-info fl"><p class="title">'
								+v.goods_name+'</p><p class="weight">'+v.spec_key_name+'</p></div><div class="price-num fr">\
	                	 <p class="price"><span>￥</span><span>'+v.member_goods_price+'</span></p><p><span>×</span><span>'+v.goods_num+'</span></p></div></li>')
							});
							d.getElementById('goods-list').innerHTML=html.join('')
							//基本信息
							d.getElementById('goods_sn').innerText=ret.data.order_sn
							d.getElementById('status').innerHTML=h.getOrderStatus(ret.data)
//							if(ret.data.return_status>0){
//								h.d.return_status.innerHTML=h.getReturnStatus(ret.data)
//								h.d.return_status.parentElement.style.display="block";
//							}else{
//								h.d.return_status.parentElement.style.display="none";
//							}
							d.getElementById('add_time').innerText=h.getYmdTime(ret.data.add_time,1)
							var time_p=[];
							if(ret.data.pay_time>0){
								time_p.push('<p><span class="title">支付时间</span><span>'+h.getYmdTime(ret.data.pay_time,1)+'</span></p>');
							}
							if(ret.data.shipping_code!='ybeyaoshop'&&ret.data.shipping_time>0){
								time_p.push('<p><span class="title">发货时间</span><span>'+h.getYmdTime(ret.data.shipping_time,1)+'</span></p>');
							}
							if(ret.data.confirm_time>0){
								time_p.push('<p><span class="title">确认收货</span><span>'+h.getYmdTime(ret.data.confirm_time,1)+'</span></p>');
							}
							d.getElementById('times').innerHTML=time_p.join('')
							d.getElementById('pay_name').innerText=ret.data.pay_name
							d.getElementById('shipping_name').innerText=ret.data.shipping_name
							d.getElementById('note').innerText=ret.data.user_note
							//配送门店
							if(ret.data.shop_info){
								h.d.shop_name.innerText=ret.data.shop_info.shop_name;
								h.d.shop_name.parentElement.style.display='block';
							}else{
								h.d.shop_name.parentElement.style.display='none';
							}
							
							d.getElementById('sum_amount').innerText="￥"+h.fmoney(ret.data.goods_price-ret.data.discount_money)
							d.getElementById('sum_ps').innerText="￥"+ret.data.shipping_price
							h.showPriceText(h.d.blance,ret.data.user_money,'-')
							h.showPriceText(h.d.point,ret.data.integral_money,'-')
							h.showPriceText(h.d.coupon,ret.data.coupon_price,'-')
							h.showPriceText(h.d.order_amount,ret.data.order_amount)
//							d.getElementById('blance').innerText="-￥"+ret.data.user_money
//							d.getElementById('point').innerText="-￥"+ret.data.integral_money
//							d.getElementById('coupon').innerText="-￥"+ret.data.coupon_price
//							d.getElementById('order_amount').innerText="￥"+ret.data.order_amount
							d.getElementById('pay-title').innerText=(ret.data.pay_code=='alipay'||ret.data.pay_code=='wxpay')?"已付金额":"未付金额";
							var btn=[]
							if(ret.data.order_status>=3){//已完成、已取消、已关闭交易、退款单
								if(ret.data.order_status==4){//已完成
									btn.push('<span class="mui-btn mui-btn-warning" type="return-order">退款/货</span>');
								}
								if(ret.data.return_status>0){
									btn.push('<span class="mui-btn mui-btn-nav" type="show-order">退款详情</span>')
								}
			        			btn.push('<span class="mui-btn mui-btn-link del-order" type="del-order">删除订单</span>');
				        	}else{
				        		if(ret.data.pay_status>0){
				        			if(ret.data.return_status>0){
				        				btn.push('<span class="mui-btn mui-btn-nav" type="show-order">退款详情</span>')
				        				if(ret.data.return_status<3 ||(ret.data.return_status>2&&ret.data.return_status<5&&ret.data.return_info.type==0)){//待审核，已拒绝，订单可进行后续操作
				        					if(ret.data.order_status==2){
						        				btn.push('<span class="mui-btn mui-btn-nav comment-order" type="comment-order"><span class="mui-icon mui-icon-compose"></span>评价订单</span>');
						        			}else{
						        				if(ret.data.shipping_status>0){
						        					btn.push('<span class="mui-btn mui-btn-success" type="confirm-order">确认收货</span>')
						        				}
						        			}
				        				}else{
				        					if(ret.data.return_status==4){
					        					btn.push('<span class="mui-btn mui-btn-link del-order" style="border: 1px solid #007aff;" type="del-order">删除订单</span>');
				        					}
				        				}
				        			}else{
				        				if(ret.data.order_status==2){
					        				btn.push('<span class="mui-btn mui-btn-nav comment-order" type="comment-order"><span class="mui-icon mui-icon-compose"></span>评价订单</span>');
					        			}else{
					        				if(ret.data.shipping_status>0){
					        					btn.push('<span class="mui-btn mui-btn-success" type="confirm-order">确认收货</span>')
					        				}
					        			}
					        			btn.push('<span class="mui-btn mui-btn-warning" type="return-order">退款/货</span>');
				        			}
					        	}else{
					        		if(ret.data.pay_code=='cod'){
					        			if(ret.data.shipping_status>0){
					        				btn.push('<span class="mui-btn mui-btn-success" type="confirm-order">确认收货</span>')
					        			}
					        		}else{
					        			btn.push('<span class="mui-btn mui-btn-red" type="pay-order">立即付款</span>');
					        		}
					        		btn.push('<span class="mui-btn mui-btn-grey" type="cansel-order">取消订单</span>');
					        	}
				        	}
				        	d.getElementById('btns').innerHTML=btn.join('')
						}else{
							h.noContent()
						}
					},
					error:function(ret){
						h.noContent()
					}
				});
			}
			h.showPriceText=function(o,v,f){
				var f=f||'';
				if(v>0){
					o.innerText=f+"￥"+v;
					o.parentElement.style.display="block"
				}else{
					o.parentElement.style.display="none"
				}
			}
			h.getReturnStatus=function(order){
				var color='';
				switch(order.return_status){
					case 1:
						color="orange";
						break;
					case 2:
						color="#FF5053;";
						break;
					case 3:
						color="#41cea9";
						break;
				}
				return '<font'+(color?' color="'+color+'"':'')+'>'+order.return_status_desc+'</font>';
			}
			h.getOrderStatus=function(order){
				if(order.return_status>0&&order.return_info.type==1){
					return h.getReturnStatus(order)
				}
				if(order.order_status_code=='CANCELLED'&&order.pay_status==0){
					order.order_status_desc+='(未支付)'
				}
				return '<font class="'+(order.order_status_code=='WAITPAY'?" red":"")+'">'+order.order_status_desc+'</font>'
			}
			h.noContent=function(){
				h.d.loader.style.display="none";
				d.getElementById('no-order').setAttribute('style','')
				d.getElementById('order').setAttribute('style','display: none;')
				setTimeout(function(){
					$.back()
				},1500)
			}
			$.plusReady(function(){
				h._self=plus.webview.currentWebview();
				h.orderListWin=plus.webview.getWebviewById('order-list');
				h.order_id=h._self.order_id
				h.service=h._self.btn
				h.token=ms.getItem('token')
				h.getOrderDetail()
				h.getchannel()
				
				/**
				 * 订单操作
				 * @param {Object} type
				 * @param {Object} order_id
				 * @param {Object} o
				 */
				h.orderService=function(type,o){
					var txt=o.innerText
					switch(type){
						case 'pay-order':
							h.d.payBtn=o;
							$('#pay_list').popover('toggle')
							break
						case 'del-order':
						case 'cansel-order':
							plus.nativeUI.showWaiting('正在'+txt+'...')
							$.ajax(h.apiurl,{
								type:"post",
								async:true,
								dataType:'json',
								data:{
									m:'order_service',
									token:h.token,
									id:h.order_id,
									type:type,
								},
								success:function(ret){
									plus.nativeUI.closeWaiting()
									if(ret.code==0){
										$.toast(txt+'成功')
										if(type=='cansel-order'){
											d.getElementById('status').innerText="已取消";
											d.getElementById('btns').innerHTML=""
											$.fire(h.orderListWin,'reloadOrderStatus');
										}else{
											setTimeout(function(){
												$.back()
											},1500)
										}
									}else{
										$.toast(ret.msg||txt+'失败')
									}
								},
								error:function(ret){
//									alert(JSON.stringify(ret))
									plus.nativeUI.closeWaiting()
								}
							});
							break
						case 'return-order':
							h.openWin('order-return.html','order-return',{order_id:h.order_id})
							break
						case 'comment-order':
							h.openWin('comment-list.html','comment-list',{type:'WAITCCOMMENT'})
							break;
						case 'confirm-order':
							plus.nativeUI.showWaiting('正在'+txt+'...')
							$.ajax(h.apiurl,{
								type:"post",
								async:true,
								dataType:'json',
								data:{
									m:'order_service',
									token:h.token,
									id:h.order_id,
									type:type,
								},
								success:function(ret){
									plus.nativeUI.closeWaiting()
									if(ret.code==0){
										$.toast(txt+'成功')
										$.fire(h.orderListWin,'reloadOrderStatus');
										h.getOrderDetail()
									}else{
										$.toast(ret.msg||txt+'失败')
									}
								},
								error:function(ret){
									plus.nativeUI.closeWaiting()
								}
							});
							break
						case 'show-order':
							h.openWin('return-detail.html','return-detail',{order_id:h.order_id})
							break;
					}
				}
				
				d.getElementById('del').addEventListener('tap',function(){
					h.orderService('del-order',h.del.obj)
				})
				d.getElementById('cansel_order').addEventListener('tap',function(){
					h.orderService('cansel-order',h.cansel.obj)
				})
				
				$('#pay_list').on('tap','.pay',function(){
					var pay_type=this.getAttribute('type');
					h.pay('pay_order',pay_type,h.order_id,function(ret){
						if(ret.status){
							//隐藏支付按钮
							h.d.payBtn.style.display="none";
							var w=plus.nativeUI.showWaiting('订单支付成功')
							h.getOrderDetail(w)
						}else{
							$.toast(ret.msg)
						}
					})
				})
				
				/**
				 * 按钮事件
				 */
				$('#btns').on('tap','.mui-btn',function(){
					var type=this.getAttribute('type')
					if(type=='del-order'){
						h.del={
							obj:this
						}
						$('#delete').popover('toggle')
					}else if(type=='cansel-order'){
						h.cansel={
							obj:this
						}
						$('#cansel').popover('toggle')
					}else{
						h.orderService(type,this)
					}
				})
				
				//查看商品详情
				$('#goods-list').on('tap','li',function(){
					var goods_id = this.getAttribute('goods_id');
					if(!h.detailWebView) {
						h.detailWebView = plus.webview.getWebviewById('goods-header');
					}
					if(!h.detailSubpage) {
						h.detailSubpage = plus.webview.getWebviewById('goods-detail');
					}
					$.fire(h.detailWebView, 'goodsId', {
						goods_id:goods_id
					})
					h.detailWebView.show('slide-in-right', 300)
				})
				
				h.swipeClose(win)
				
				$.back=function(){
					h._self.close('slide-out-right')
				}
			})
		}(window, document, mui, honey, myStorage))
    </script>
	</body>

</html>

