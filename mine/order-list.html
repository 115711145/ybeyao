<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的订单</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link type="text/css" rel="stylesheet" href="../css/mui.min.css" />
		<link type="text/css" rel="stylesheet" href="../css/own.css" />
		<link type="text/css" rel="stylesheet" href="../css/iconfont/iconfont.css" />
		<link type="text/css" rel="stylesheet" href="../css/icons-extra.css" />
		<link type="text/css" rel="stylesheet" href="../css/order-list.css" />
	</head>
	<body>
		<header class="mui-bar mui-bar-nav own-main-background-color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="back"></a>
			<h1 class="mui-title" id="header-title">我的订单</h1>
			<div class="top-btn">
				<div class="mui-segmented-control mui-segmented-control-honey" id="type-item">
					<a class="mui-control-item mui-active" type="ALL" index="0">全部</a>
					<a class="mui-control-item" type="WAITPAY" index="1">待付款</a>
					<a class="mui-control-item" type="WAITSEND" index="2">待发货</a>
					<a class="mui-control-item" type="WAITRECEIVE" index="3">待收货</a>
					<a class="mui-control-item" type="FINISH" index="4">已完成</a>
				</div>
			</div>
		</header>
		<div class="mui-content" id="content">
			<div class="loader" id="loader">
				<a>
					<span class="mui-spinner"></span>
				</a>
				<br />
				<span>加载中...</span>
			</div>
			<ul class="sc_list" id="list">
				<li class="no-order">没有相关订单<li>
				<!--<li>
					<div class="order_sn">订单编号：12345654456
						<span class="status">已付款</span>
					</div>
					<div class="order-goods fl">
		                <div class="goods-img fl">
		                	<img src="http://ybuser.ybyiyao.com/public/upload/goods/thumb/3580/goods_thumb_3580_200_200.jpeg">
		                </div>
		                <div class="goods-info fl">
		                    <p class="title">
		                    	云南白药 气血康胶囊24粒（买五送一送原品）云南白药 气血康胶囊24粒（买五送一送原品）
		                    </p>
		                    <p class="weight">套餐:套餐一 买赠:买赠一</p>
		                </div>
		                <div class="price-num fr">
		                	 <p class="price">
		                        <span>￥</span><span>10001.00</span>
		                	</p>
		                	<p>
		                		<span>×</span><span>1100</span>
		                	</p>
		                </div>
			        </div>
			        <div class="order-goods fl">
		                <div class="goods-img fl">
		                	<img src="http://ybuser.ybyiyao.com/public/upload/goods/thumb/3580/goods_thumb_3580_200_200.jpeg">
		                </div>
		                <div class="goods-info fl">
		                    <p class="title">
		                    	云南白药 气血康胶囊24粒（买五送一送原品）
		                    </p>
		                    <p class="weight">套餐:套餐一 买赠:买赠一</p>
		                </div>
		                <div class="price-num fr">
		                	 <p class="price">
		                        <span>￥</span><span>10001.00</span>
		                	</p>
		                	<p>
		                		<span>×</span><span>1100</span>
		                	</p>
		                </div>
			        </div>
			        <div class="sum">
			        	<p class="fl sum-price-num">
			        		<span class="price">￥120.00</span>
			        		<span>共4件</span>
			        	</p>
			        	<p class="fr btns">
			        		<span class="mui-btn mui-btn-red">立即付款</span>
			        		<span class="mui-btn mui-btn-warning">退款</span>
			        		<span class="mui-btn mui-btn-grey">取消订单</span>
						</p>
					</div>
				</li>-->
	       </ul>
		</div>
		<div id="delete" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="del">
					<a href="#delete" style="color: #FF3B30;">删除订单</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#delete" style="color: #999;">取消</a>
				</li>
			</ul>
		</div>
		<div id="cansel" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="cansel_order">
					<a href="#cansel" style="color: #FF3B30;">取消订单</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#cansel" style="color: #999;">取消</a>
				</li>
			</ul>
		</div>
		<div id="pay_list" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" type="weixin" >
					<a style="color:#999">选择支付方式</a>
				</li>
				<li class="mui-table-view-cell pay" type="wxpay" >
					<a href="#pay_list" ><span class="mui-icon mui-icon-weixin" style="color:#41CEA9;margin-right:5px ;"></span>微信支付</a>
				</li>
				<li class="mui-table-view-cell pay" type="alipay">
					<a href="#pay_list" ><span class="mui-icon-extra mui-icon-extra-alipay" style="font-size: 20px;"></span>
						支付宝支付</a>
				</li>
				<!--<li class="mui-table-view-cell" type="hdfk">
					<a href="#" >货到付款</a>
				</li>-->
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" type="cansel">
					<a href="#pay_list" style="color: #999;" >取消</a>
				</li>
			</ul>
		</div>
    <script type="text/javascript" src="../js/mui.min.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/common.js" charset="UTF-8"></script>
    <script type="text/javascript">
    	(function(win, d, $, h, ms) {
			$.init({
				pullRefresh: {
					container: '#content',
//					down: {
//						style:'circle',
//					    color:'#41cea9',
//					    height:'80px',
//						callback: refresh
//					},
					up: {
						auto:false,
						height:80,
						contentinit: h.contentinit,
	                    contentdown: h.contentdown,
	                    contentrefresh: h.contentrefresh,
						contentnomore:h.contentnomore,
						callback: getOrderList 
					}
				}
			});
			h.d = {
				btn_items:$('.mui-control-item'),
				content:$('#content'),
				list: d.getElementById('list'),
				xz_pay:d.getElementById('xz_pay'),
				pay_list:d.getElementById('pay_list'),
				loader:d.getElementById('loader'),
				type_item:d.getElementById('type-item')
			}
			function getOrderList(){
				if(h.page==1){
					h.d.list.innerHTML='';
					h.d.loader.style.display="block";
				}
				$.ajax(h.apiurl,{
					type:"post",
					async:true,
					dataType:'json',
					data:{
						m:'order_list',
						token:h.token,
						p:h.page,
						type:h.type
					},
					success:function(ret){
						if(ret.code==-1){
							$.fire(plus.webview.getWebviewById('mine'),'logout')
							h.openWin('login.html','login')
							$.back()
							return
						}
						h.d.loader.style.display="none";
						h.showOrderList(ret.data)
//						if(ret.code==0){
							h.page++;
//						}
						(!ret.data ||ret.data.length<10)?h.d.content.pullRefresh().disablePullupToRefresh():(h.d.content.pullRefresh().enablePullupToRefresh(),h.d.content.pullRefresh().endPullupToRefresh(false))
					},
					error:function(ret){
//						alert(ret.responseText)
//						alert(JSON.stringify(ret))
//						alert('error')
					}
				});
				
			}
			
			/**
			 * 显示订单商品列表 
			 * @param {Object} data
			 */
			h.showOrderList = function(data) {
				var html = [];
				if(data.length > 0) {
					$.each(data, function(i, v) {
						var li=[];
						li.push('<li class="order-list" order_id="'+v.order_id+'" return_status="'+v.return_status+'"><div class="order_sn">订单编号：'+v.order_sn
						+'<span class="status">'+h.getOrderStatus(v)+'</span></div>');
						var num=0;
						//商品列表
						for(var j=0;j<v.goods_list.length;j++){
							var val=v.goods_list[j];
							num+=num+parseInt(val.goods_num)
							var img=h.getGoodsImgUrl(val.goods_id,val.img_id)
							var cls='';
							if(val.return_status>0&&val.return_status<5){
								cls=' is-return';
								val.goods_name='<font color="red">[退]</font>'+h.cutstr(val.goods_name);
							}
							li.push('<div class="order-goods fl'+cls+'" goods_id="'+val.goods_id+'">'
			                +'<div class="goods-img fl">'
			                	+'<img src="'+img+'" onerror="javascript:this.src=\'../images/default.png\'"/>'
			                +'</div>'
			                +'<div class="goods-info fl">'
			                    +'<p class="title">'+h.cutstr(val.goods_name)+'</p>'
			                    +'<p class="weight">'+val.spec_key_name+'</p></div>'
			                +'<div class="price-num fr">'
			                	 +'<p class="price">'
			                        +'<span>￥</span><span>'+val.member_goods_price+'</span>'
			                	+'</p><p><span>×</span><span>'+val.goods_num+'</span></p></div></div>');
						}
						//应付金额
						li.push('<div class="sum"><p class="fl sum-price-num">'
			        		+'<span class="price">￥'+h.fmoney(v.total_amount-v.discount_money)+'</span>'
			        		+'<span>共'+num+'件</span></p><p class="fr btns">');
			        		li.push(h.getOrderBtn(v));
				        	li.push('</p></div></li>')
							html.push(li.join(''))
					});
					h.d.list.innerHTML+=html.join('')
				}else{
					h.page==1&&(h.d.list.innerHTML = '<li class="no-order">没有相关订单<li>');
				}
			}
			h.getOrderStatus=function(order){
				if(order.return_status>0&&order.return_info.type==1){
					switch(order.return_status){
						case 1:
							color="orange";
							break;
						case 2:
							color="#FF5053";
							break;
						case 3:
							color="#41cea9";
							break;
						default:
							color="#666";
					}
					return '<font'+(color?' color="'+color+'"':'')+'>'+order.return_status_desc+'</font>';
				}else{
					return '<font class="'+(order.order_status_code=='WAITPAY'?" red":"")+'">'+order.order_status_desc+'</font>'
				}
			}
			
			h.getOrderBtn=function(order){
				var li=[];
				if(order.order_status>=3){//已完成、已取消、已作废
	        		if(order.return_status>0){
	        			li.push('<span class="mui-btn mui-btn-nav" type="show-order">退款详情</span>')
	        		}
	        		li.push('<span class="mui-btn mui-btn-link" type="del-order">删除订单</span></div></li>');
	        	}else{
	        		if(order.pay_status>0){
	        			li.push('<span class="mui-btn mui-btn-warning" type="return-order">退款/货</span>');
	        			if(order.return_status>0){
	        				li.push('<span class="mui-btn mui-btn-nav" type="show-order">退款详情</span>')
	        				if(order.return_status<3 || (order.return_status>2&&order.return_status<5&&order.return_info&&order.return_info.type==0)){
	        					if(order.order_status==2){
			        				li.push('<span class="mui-btn mui-btn-nav" type="comment-order">评价订单</span>');
			        			}else{
			        				if(order.shipping_status>0){
			        					li.push('<span class="mui-btn mui-btn-success" type="confirm-order">确认收货</span>')
			        				}
			        			}
	        				}else{
	        					if(order.return_status==4){
        							li.push('<span class="mui-btn mui-btn-link" type="del-order">删除订单</span></div></li>');
	        					}
	        				}
	        			}else{
		        			if(order.order_status==2){
		        				li.push('<span class="mui-btn mui-btn-nav" type="comment-order">评价订单</span>');
		        			}else{
		        				if(order.shipping_status>0){
		        					li.push('<span class="mui-btn mui-btn-success" type="confirm-order">确认收货</span>')
		        				}
		        			}			        				
	        			}
		        	}else{
		        		if(order.pay_code=='cod'){
		        			if(order.shipping_status>0){
		        				li.push('<span class="mui-btn mui-btn-success" type="confirm-order">确认收货</span>')
		        			}
		        		}else{
		        			li.push('<span class="mui-btn mui-btn-red" type="pay-order">立即付款</span>');
		        		}
		        		li.push('<span class="mui-btn mui-btn-grey" type="cansel-order">取消订单</span>');
		        	}
	        	}
	        	return li.join('');
			}
			
			h.showType=function(type){
				var type=type||h.type;
				$.each(h.d.btn_items, function(i,v) {
					v.setAttribute('class','mui-control-item'+(v.getAttribute('type')==type?' mui-active':''))
				});
			}
			h.removeOrderItem=function(obj){
				h.d.list.removeChild(obj)
				if(h.d.list.length==0){
					h.d.list.innerHTML = '<li class="no-order">没有相关订单<li>'
				}
			}
			
			$.plusReady(function() {
				h.token=ms.getItem('token');
				h._self=plus.webview.currentWebview();
				h.type=h._self.type|| 'ALL';
				h.index=0;
				h.mineWin=plus.webview.getWebviewById('mine')
				h.showType()
				getOrderList()
				h.getchannel();
				
				/**
				 * 切换订单类型
				 */
				$('.top-btn').on('tap','.mui-control-item',function(){
					var type=this.getAttribute('type')
					var index=this.getAttribute('index')
					if(type!=h.type){
						h.d.type_item.querySelector('.mui-active').setAttribute('class',"mui-control-item");
						this.setAttribute('class',"mui-control-item mui-active");
						h.type=type;
						h.page=1;
						h.index=index;
						h.d.content.pullRefresh().refresh(true)
						h.d.content.pullRefresh().disablePullupToRefresh()
						getOrderList()
					}
				})
				
				h.orderService=function(type,order_id,o){
					var txt=o.innerText
					switch(type){
						case 'pay-order':
							h.order_id=order_id;
							$('#pay_list').popover('toggle')
							break
						case 'del-order':
						case 'cansel-order':
							plus.nativeUI.showWaiting('正在'+txt+'...')
							$.ajax(h.apiurl,{
								type:"post",
								async:true,
								dataType:'json',
								data:{
									m:'order_service',
									token:h.token,
									id:order_id,
									type:type,
								},
								success:function(ret){
									plus.nativeUI.closeWaiting()
									if(ret.code==0){
										$.toast(txt+'成功')
										if(type=='cansel-order'){
											//变更按钮
											if(h.type=='ALL'){
												var span=o.parentElement.parentElement.parentElement.querySelector('.status')
												o.parentElement.innerHTML='<span class="mui-btn mui-btn-link" type="del-order">删除订单</span>'
												span.innerText='已取消';
												span.setAttribute('class','status')
												$.fire(h.mineWin,'reloadUser')
											}else{
												h.removeOrderItem(o.parentElement.parentElement.parentElement)
											}
										}else{
											h.removeOrderItem(o.parentElement.parentElement.parentElement)
										}
									}else{
										$.toast(ret.msg||txt+'失败')
									}
								},
								error:function(ret){
//									alert(JSON.stringify(ret))
									plus.nativeUI.closeWaiting()
								}
							});
							break
						case 'return-order':
							h.openWin('order-return.html','order-return',{order_id:order_id})
							break
						case 'comment-order':
							h.openWin('comment-list.html','comment-list',{type:'WAITCCOMMENT'})
							break;
						case 'confirm-order':
							plus.nativeUI.showWaiting('正在'+txt+'...')
							$.ajax(h.apiurl,{
								type:"post",
								async:true,
								dataType:'json',
								data:{
									m:'order_service',
									token:h.token,
									id:order_id,
									type:type,
								},
								success:function(ret){
									plus.nativeUI.closeWaiting()
									console.log(JSON.stringify(ret))
									if(ret.code==0){
										$.toast(txt+'成功')
										h.reloadOrderStatus()
									}else{
										$.toast(ret.msg||txt+'失败')
									}
								},
								error:function(ret){
									plus.nativeUI.closeWaiting()
//									alert(ret.responseText)
								}
							});
							break
						case 'show-order':
							h.openWin('return-detail.html','return-detail',{order_id:order_id})
							break
					}
				}
				
				d.getElementById('del').addEventListener('tap',function(){
					h.orderService(h.del.type,h.del.order_id,h.del.obj)
				})
				d.getElementById('cansel_order').addEventListener('tap',function(){
					h.orderService(h.cansel.type,h.cansel.order_id,h.cansel.obj)
				})
				/**
				 * 查看订单详情
				 */
				$(h.d.list).on('tap','.order_sn',function(){
					h.showDetail(this)
				})
				$(h.d.list).on('tap','.order-goods',function(){
					h.showDetail(this)
				})
				h.showDetail=function(o){
					var order_id=o.parentElement.getAttribute('order_id')
					h.openWin('order-detail.html','order-detail',{order_id:order_id})
				}
				/**
				 * 按钮事件
				 */
				$(h.d.list).on('tap','.mui-btn',function(){
					var type=this.getAttribute('type')
					var p=this.parentElement.parentElement.parentElement;
					var order_id=p.getAttribute('order_id')
					if(type=='del-order'){
						h.del={
							type:type,
							order_id:order_id,
							obj:this
						}
						$('#delete').popover('toggle')
					}else if(type=='cansel-order'){
						h.cansel={
							type:type,
							order_id:order_id,
							obj:this
						}
						$('#cansel').popover('toggle')
					}else{
						h._jump={
							order_id:order_id,
							p:p
						}
						h.orderService(type,order_id,this)
					}
				})
				
				//选择支付方式
				$(h.d.pay_list).on('tap','.pay',function(){
					h.pay_type=this.getAttribute('type')
					h.pay('pay_order',h.pay_type,h.order_id,function(ret){
						$.toast(ret.msg)
					})
				})
		
				//关闭列表 
				$('.mui-popover').on('tap', '.close-btn', function() {
					$(this.parentElement).popover('toggle')
				})
				
				$.back=function(){
					plus.webview.currentWebview().close('slide-out-right');
				}
				
				
				h.reloadOrderStatus=function(){
					$.ajax(h.apiurl,{
						type:"post",
						async:true,
						dataType:'json',
						timeout:h.ajaxTimeout,
						data:{
							m:'order_detail',
							token:h.token,
							id:h._jump.order_id
						},
						success:function(ret){
							if(ret.code==0){
								h._jump.p.querySelector('.status').innerHTML=h.getOrderStatus(ret.data)
								h._jump.p.querySelector('.btns').innerHTML=h.getOrderBtn(ret.data)
							}
						}
					});
				}
				
				win.addEventListener('reloadOrderStatus',function(){
					h.reloadOrderStatus()
				})
				
				win.addEventListener('swiperight',function(e){
					if(Math.abs(e.detail.angle)<6){
						if(h.index>0){
							$.trigger(d.getElementById('type-item').querySelectorAll('a')[h.index-1],'tap')
						}else{
							$.back()
						}
					}
				})
				win.addEventListener('swipeleft',function(e){
					var angle = Math.abs(e.detail.angle);
					if(angle>177&&angle<185&&h.index<4){
						$.trigger(d.getElementById('type-item').querySelectorAll('a')[h.index*1+1],'tap')
					}
				})
			})
		
		}(window,document, mui, honey, myStorage))
    </script>
	</body>

</html>

