<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link type="text/css" rel="stylesheet" href="../css/mui.min.css" />
		<link type="text/css" rel="stylesheet" href="../css/own.css" />
		<link type="text/css" rel="stylesheet" href="../css/iconfont/iconfont.css" />
		<link type="text/css" rel="stylesheet" href="../css/icons-extra.css" />
		<link type="text/css" rel="stylesheet" href="../css/order-detail.css" />
		<style>
			body{
				background: #fff;
			}
			#no-content{
				background: #fff;
			}
			#describe{
				border-bottom: 1px dashed #ddd;
				margin-bottom: 20px;
			}
			#remark{
				color: #319FF4;
				overflow: hidden;
				width: 50%;
				white-space: nowrap;
				text-overflow:ellipsis;
			}
			.order-info{
				padding: 10px;
				font-size: 18px;
				color: #4e5e71;
				background: #fff;
				margin: 0 !important;
			}
			.return-list{
				margin: 4px 0 10px 0;
			}
			.desc{
				clear: both;
				font-size: 14px;
				color: #4e5e71;;
				background: #fff;
				padding: 5px 15px 5px 15px;
				border-bottom: 1px solid #eee !important;
				height: 32px;
			}
			.desc span{
				display: inline-block;
			}
			.desc span:last-child{
				text-align: right;
			}
			.sc_list{
				clear: both;
			}
			.return-item{
				background: #fff;
				margin-bottom: 10px;
			}
			#order{
				background: none;
			}
			.imgs img{
				border: 1px solid #efefef;
				border-radius: 5px;
				margin: 5px !important;
				width: 45px;
				height: 45px;
			}
			.btns{
				text-align: center;
				padding: 5px;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav own-main-background-color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="back"></a>
			<h1 class="mui-title" id="header-title">退款详情</h1>
		</header>
		<div class="loader" id="loader">
			<a>
				<span class="mui-spinner"></span>
			</a>
			<br />
			<span>加载中...</span>
		</div>
		<div class="mui-content" id="no-order" style="display: none;">
			<div id="no-content">
				<p><img src="../images/kuqi.png" /></p>
				<p>您已取消退款</p>
			</div>
		</div>
		<div class="mui-content" id="order" >
			<div class="user-address" id="address">
				<!--<p>
					<span class="name">收货人：张三</span>
					<span class="phone">电话：15012345678</span>
				</p>
				<p class="address">
					收件地址：江
				</p>
				<p class="icon">
					<span class="mui-icon mui-icon-arrowright"></span>
				</p>-->
			</div>
			<div class="return-list" id="return-list">
				<!--<div class="return-item">
				   <div class="desc">
						<span class="fl">等待系统退款</span>
						<span class="fr">2017-10-10 10:10:10</span>
					</div>
					<ul class="sc_list">
						<li>
			                <div class="goods-img fl">
			                	<img src="http://ybuser.ybyiyao.com/public/upload/goods/thumb/3580/goods_thumb_3580_200_200.jpeg">
			                </div>
			                <div class="goods-info fl">
			                    <p class="title">
			                    	云南白药 气血康胶囊24粒（买五送一送原品）
			                    </p>
			                    <p class="weight">套餐:套餐一 买赠:买赠一</p>
			                </div>
			                <div class="price-num fr">
			                	 <p class="price">
			                        <span>￥</span><span>10001.00</span>
			                	</p>
			                	<p>
			                		<span>×</span><span>1100</span>
			                	</p>
			                </div>
				        </li>
				        <li>
			                <div class="goods-img fl">
			                	<img src="http://ybuser.ybyiyao.com/public/upload/goods/thumb/3580/goods_thumb_3580_200_200.jpeg">
			                </div>
			                <div class="goods-info fl">
			                    <p class="title">
			                    	云南白药 气血康胶囊24粒（买五送一送原品）
			                    </p>
			                    <p class="weight">套餐:套餐一 买赠:买赠一</p>
			                </div>
			                <div class="price-num fr">
			                	 <p class="price">
			                        <span>￥</span><span>10001.00</span>
			                	</p>
			                	<p>
			                		<span>×</span><span>1100</span>
			                	</p>
			                </div>
				        </li>
			       </ul>
			        <div class="amout-list" style="padding-bottom: 20px;">
			       		<p style="display: none;"><span class="title">审核说明</span><span id="remark"></span></p>
			       		<p><span class="title">退款金额</span><span id="sum_amount" class="price">￥0</span></p>
			       		<p><span class="title">退款原因</span><span id="reason"></span></p>
			       		<p><span class="title">问题描述</span><span></span></p>
			       		<p class="describe">
			       			<div class="imgs">
			       				<img src="../images/ad1.jpg" width="50" height="50"/>
			       			</div>
			       		</p>
			       		<div class="btns" id="btns">
			       			
			       		</div>
			       </div>
			     </div>-->
				</div>
	       </div>
		</div>
		<div id="cancel" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="cansel-btn">
					<a href="#cancel">取消退款</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#cancel" style="color: #999;">返回</a>
				</li>
			</ul>
		</div>
    <script type="text/javascript" src="../js/mui.min.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/common.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/mui.lazyload.js" charset="UTF-8"></script>
	<script type="text/javascript" src="../js/mui.lazyload.img.js" charset="UTF-8"></script>
    <script type="text/javascript">
    	(function(win, d, $, h, ms) {
			$.init();
			h.d={
				address:d.getElementById('address'),
				loader:d.getElementById('loader'),
				return_list:d.getElementById('return-list'),
			}
			h.getOrderDetail=function(){
				if(!h.order_id>0){
					h.noContent()
					return
				}
				$.ajax(h.apiurl,{
					type:"post",
					async:true,
					dataType:'json',
					data:{
						m:'return_order_detail',
						token:h.token,
						id:h.order_id
					},
					timeout:h.ajaxTimeout,
					success:function(ret){
						if(ret.code==0){
							h.d.loader.style.display="none";
			        		d.getElementById('order').style.display="block";
							h.data=ret.data;
							//收货地址
							h.d.address.innerHTML='<div class="user"><p><span class="name">收货人：'+ret.data[0].consignee+'</span>\
							<span class="phone">电话：'+ret.data[0].mobile+'</span></p><p class="address">\
							收件地址：'+ret.data[0].address+'</p></div>';
							h.d.return_list.innerHTML=h.getReturnListHtml(h.data)
							$('#return-list').imageLazyload({
								placeholder: '../images/default.png'
							});
//							return
							//商品列表
//							var html=[];
//							$.each(ret.data.goods_list, function(i,v) {
////								var img=h.apihost+'/public/upload/goods/thumb/'+v.goods_id+'/goods_sub_thumb_'+v.img_id+'_150_150.jpg';
//								var img=h.getGoodsImgUrl(v.goods_id,v.img_id);
//								console.log(img)
//								html.push('<li><div class="goods-img fl"><img data-lazyload="'+img+'"></div><div class="goods-info fl"><p class="title">'
//								+v.goods_name+'</p><p class="weight">'+v.spec_key_name+'</p></div><div class="price-num fr">\
//	                	 <p class="price"><span>￥</span><span>'+v.member_goods_price+'</span></p><p><span>×</span><span>'+v.goods_num+'</span></p></div></li>')
//							});
//							d.getElementById('goods-list').innerHTML=html.join('')
//							$('#return-list').imageLazyload({
//								placeholder: '../images/default.png'
//							});
//							//退款信息
//							d.getElementById('goods_sn').innerText=ret.data.order_sn
//							var d_status=d.getElementById('status');
//							d_status.innerText=ret.data.return_status_desc
//							var color='';
//							switch(ret.data.status){
//								case 1:
//									color="orange";
//									break;
//								case 2:
//									color="#FF5053";
//									h.d.remark.innerText=ret.data.remark;
//									h.d.remark.parentElement.style.display="block";
//									break;
//								case 3:
//									color="#41cea9";
//									break;
//							}
//							if(color){
//								d_status.setAttribute('style','color: '+color+';')
//							}
//							if(ret.data.status!=2){
//								h.d.remark.parentElement.style.display="none";
//							}
//							d.getElementById('add_time').innerText=h.getYmdTime(ret.data.addtime,1)
//							d.getElementById('sum_amount').innerText="￥"+h.fmoney((ret.data.refund_deposit*100+ret.data.refund_money*100)/100)
//							d.getElementById('reason').innerText=ret.data.reason
//							d.getElementById('describe').innerText=ret.data.describe
//							if(ret.data.status<3){
//								d.getElementById('btns').innerHTML='<span class="mui-btn mui-btn-grey">取消退款</span>';
//							}
						}else{
							h.noContent()
						}
					},
					error:function(ret){
						h.noContent()
					}
				});
			}
			h.getReturnListHtml=function(data){
				var str=[];
				$.each(data, function(i,v) {
					var color=v.status>1?(v.status>2?"#41cea9":"#FF5053"):"orange";
					str.push('<div class="return-item"><div class="desc"><span class="fl"><font color="'+color+'">'+v.return_status_desc+'</font></span><span class="fr">'+h.getYmdTime(v.addtime,1)+'</span></div>');
					str.push(h.getGoodsListHtml(v.goods_list));
					str.push('<div class="amout-list" style="padding-bottom: 20px;">')
			       	str.push('<p><span class="title">退款原因</span><span id="reason">'+v.reason+'</span></p>')
			       	str.push('<p><span class="title">退款金额</span><span id="sum_amount" class="price">￥'+h.fmoney((v.refund_deposit*100+v.refund_money*100)/100)+'</span></p>')
			       	v.refund_integral>0&&str.push('<p><span class="title">积分</span><span id="reason">'+v.refund_integral+'</span></p>')
			       	v.status==2&&str.push('<p><span class="title">审核说明</span><span class="remark">'+v.remark+'</span></p>')
			       	str.push('<p><span class="title">问题描述</span><span></span></p>')
			       	var img_str=[];
			       	if(v.imgs){
			       		img_str.push('<div class="imgs">');
			       		var imgs=v.imgs.split(',');
			       		for(var j=0;j<imgs.length;j++){
			       			img_str.push('<img src="'+h.apihost+imgs[j]+'"/>')
			       		}
			       		img_str.push('</div>')
			       	}
			       	str.push('<p id="describe">'+v.describe+img_str.join('')+'</p>')
		       		if(v.status<3){
						str.push('<div class="btns"><span class="mui-btn mui-btn-grey"  return-id="'+v.return_id+'">取消退款</span></div>')
		       		}
			       	str.push('</div></div>');	
				});
				return str.join('')
			}
			
			h.getGoodsListHtml=function(list){
				var html=['<ul class="sc_list">'];
				$.each(list, function(i,v) {
					var img=h.apihost+'/public/upload/goods/thumb/'+v.goods_id+'/goods_sub_thumb_'+v.img_id+'_150_150.jpg';
					html.push('<li><div class="goods-img fl"><img data-lazyload="'+img+'"></div><div class="goods-info fl"><p class="title">'
					+v.goods_name+'</p><p class="weight">'+v.spec_key_name+'</p></div><div class="price-num fr">\
        	 <p class="price"><span>￥</span><span>'+v.member_goods_price+'</span></p><p><span>×</span><span>'+v.return_num+'</span></p></div></li>')
				});
				html.push('</ul>');
				return html.join('');
			}
			
			
			h.noContent=function(){
				h.d.loader.style.display="none";
				d.getElementById('no-order').setAttribute('style','')
				d.getElementById('order').setAttribute('style','display: none;')
				setTimeout(function(){
					$.back()
				},1500)
			}
			
			$.plusReady(function(){
				h._self=plus.webview.currentWebview();
				h.orderListWin=plus.webview.getWebviewById('order-list');
				h.mineWin=plus.webview.getWebviewById('mine');
				h.order_id=h._self.order_id
				h.service=h._self.btn
				h.token=ms.getItem('token')
				h.getOrderDetail()
				
				/**
				 * 取消按钮事件
				 */
				$('#btns').on('tap','.mui-btn-grey',function(){
					$('#cancel').popover('toggle')
				})
				
				$(h.d.return_list).on('tap','.mui-btn-grey',function(){
					if(h.is_cansel){
						return
					}
					var return_id=this.getAttribute('return-id');
					h.is_cansel=true;
					plus.nativeUI.showWaiting('正在取消退款...');
					$.ajax(h.apiurl,{
						type:"post",
						async:true,
						timeout:h.ajaxTimeout,
						dataType:'json',
						data:{
							m:'order_service',
							type:'cansel-return',
							id:h.order_id,
							return_id:return_id,
							token:h.token
						},
						success:function(ret){
							h.is_cansel=false;
							plus.nativeUI.closeWaiting()
							if(ret.code==0){
								$.toast('取消退款已成功！')
								$.fire(h.mineWin,'reloadUser')
								$.fire(h.orderListWin,'reloadOrderStatus')
								setTimeout(function(){
									$.back()
								})
							}else{
								$.toast(ret.msg||'取消退款失败')
							}
						},
						error:function(ret){
//							$.toast('取消退款失败')
						}
					});
				})
				
				h.swipeClose(win)
				
				
				$(h.d.return_list).on('tap','.remark',function(){
					$.alert(this.innerText,'审核说明')
				})
				
				$.back=function(){
					h._self.close('slide-out-right')
				}
			})
		}(window, document, mui, honey, myStorage))
    </script>
	</body>

</html>

