<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link type="text/css" rel="stylesheet" href="../css/mui.min.css" />
		<link type="text/css" rel="stylesheet" href="../css/own.css" />
		<link type="text/css" rel="stylesheet" href="../css/iconfont/iconfont.css" />
		<link type="text/css" rel="stylesheet" href="../css/icons-extra.css" />
		<link type="text/css" rel="stylesheet" href="../css/buy-content.css" />
		<style>
			#warm{
				color: #FF5053;
				font-size: 12px;
			}
			#warm span{
				display: block;
			}
			#shops-fdbs .fr{
				color: #999;
				font-size:12px
			}
			#fdbs-list .shop_name {
				font-size: 16px;
				padding: 5px  ;
			}
			#fdbs-list .shop_address,#fdbs-list .phone {
				padding-left: 20px;
				margin: 0;
				font-size: 13px;
			}
		</style>
	</head>
	<body>
		<div class="mui-content" id="content">
			<div class="user-address" id="address">
				<div class="user">
					<!--<p id="no-address">添加收货地址</p>-->
				</div>
				<div class="icon">
					<span class="mui-icon mui-icon-arrowright"></span>
				</div>
			</div>
			<ul class="sc_list" id="buy-list">
				<!--<li>
	                <div class="goods-img fl">
	                	<img src="http://ybuser.ybyiyao.com/public/upload/goods/thumb/3580/goods_thumb_3580_200_200.jpeg">
	                </div>
	                <div class="goods-info fl">
	                    <p class="title">
	                    	云南白药 气血康胶囊24粒（买五送一送原品）
	                    </p>
	                    <p class="weight">套餐:套餐一 买赠:买赠一</p>
	                </div>
	                <div class="price-num fr">
	                	 <p class="price">
	                        <span>￥</span><span>10001.00</span>
	                	</p>
	                	<p>
	                		<span>×</span><span>1100</span>
	                	</p>
	                </div>
		        </li>-->
	       </ul>
	       
	       <div class="order">
		       	<p id="xz_peisong">
		       		<span class="title">配送方式</span><a id="peisong">配送到家</a>
		       		<span class="mui-icon mui-icon-arrowright"></span>
		       	</p>
		       	<p id="xz_fdbs">
		       		<span class="title">选择门店</span><a id="fdbs">总店</a>
		       		<span class="mui-icon mui-icon-arrowright"></span>
		       	</p>
		       	<!--<p>
		       		<span class="title">使用余额</span><input id="ye" type="number" class="mui-input-clear number" min="0" max="0" placeholder="可用余额0" />
		       	</p>
		       	<p>
		       		<span class="title">使用积分</span><input id="jf" type="number" class="mui-input-clear number" min="0" max="0" placeholder="可用积分0" />
		       	</p>-->
		       	<p>
		       		<span class="title">使用券码 </span><input id="qm" type="text" class="mui-input-clear number" placeholder="填写优惠券券码" />
		       	</p>
		       	<p id="xz_quan">
		       		<span class="title">优 惠 券 </span><span id="yhq">不使用优惠券</span>
		       		<span class="mui-icon mui-icon-arrowright"></span>
		       	</p>
		       	<p>
		       		<span class="title" id="beizhu">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;备 注 </span><textarea id="textarea" maxlength="50" rows="5" placeholder="备注内容(50字内)"></textarea>
		       	</p>
		       	<p id="warm">
		       		<span id="free" style="display: none;"> * 本次订单的商品金额未满<font id="freight_free">100</font>元，将收取配送费用</span>
		       		<span id="out-ps" style="display: none;"> * 您已超出<font id="ps-hour">5</font>小时配送服务区域,我们将在48小时内为您配送</span>
		       	</p>
	       </div>
	       <div class="amout-list">
	       		<p><span class="title">商品金额:</span><span class="price" id="sum_amount">￥123</span></p>
	       		<p><span class="title">配送费用:</span><span class="price" id="sum_ps">￥0</span></p>
	       		<p><span class="title">余额抵扣:</span><span class="price" id="blance">-￥0</span></p>
	       		<p><span class="title">积分抵扣:</span><span class="price" id="point">-￥0</span></p>
	       		<p><span class="title">折扣优惠<font id="discount_txt"></font>:</span><span class="price" id="discount">-￥0</span></p>
	       		<!--<p><span class="title">活动优惠:</span><span class="price" id="ladder">-￥0</span></p>-->
	       		<p><span class="title">使用优惠券:</span><span class="price" id="coupon">-￥0</span></p>
	       </div>
		</div>
		<div id="quan" class="mui-popover mui-popover-action mui-popover-bottom">
            <div class="mui-scroll-wrapper" id="quan-wrapper">
                <div class="mui-scroll quan-list" id="quan-list"> 
                    <!--<div class="quan">
						<div class="quan-con">
							<div class="fl title">
								<p class="number"><font>5</font><span>元(满100元可用)</span></p>
								<p class="use-time">有效期至: 2017-11-02 10:10:00</p>
							</div>
							<div class="fr getquan">
								<p>使用优惠券</p>
							</div>
						</div>
					</div>-->
					<div class="no-quan">没有可用的券</div>
                </div>
            </div>
            <div class="close-btn">
					完成 
			</div>
        </div>
		<div id="peisongfs" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view psfs" id="psfs">
				
			</ul>
			<ul class="mui-table-view close-btn">
				<li class="mui-table-view-cell">关闭</li>
			</ul>
		</div>
		<div id="user-address" class="mui-popover mui-popover-action mui-popover-bottom">
			<div class="mui-scroll-wrapper" id="address-wrapper">
                <div class="mui-scroll address-list" id="address-list"> 
                	<!--<div class="address-item">
                		<p>
							<span class="name">收货人：张三</span>
							<span class="phone">电话：15012345678</span>
						</p>
						<p class="address">
							收件地址：江西省-赣州市-章贡区江西省-赣州市-章贡区江西省-赣州市-章贡区江西省-赣州市-章贡区
						</p>
						<p class="icon">
							<span class="mui-icon mui-icon-arrowright"></span>
						</p>
                	</div>-->
                	
                </div>
            </div>
			<div class="close-btn">
					完成 
			</div>
		</div>
		<div id="shops-fdbs" class="mui-popover mui-popover-action mui-popover-bottom">
			<div class="mui-scroll-wrapper" id="shop-wrapper">
                <div class="mui-scroll fdbs-list" id="fdbs-list"> 
                	<!--<div class="no-fdbs">
                		您附近没有可选的门店
                	</div>-->
                	<!--<div class="fdbs-item">
                		<p class="shop_name"><img src="../images/fdbs.png" height="15" /> 总店</p>
                		<p>地址：总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店总店</p>
                	</div>
                	<div class="fdbs-item">
                		<p class="shop_name"><img src="../images/fdbs.png" width="15" />总店</p>
                		<p>地址：总店总店总店总店总店总店</p>
                	</div>
                	<div class="fdbs-item">
                		<p class="shop_name">总店</p>
                		<p>地址：总店总店总店总店总店总店</p>
                	</div>-->
                </div>
            </div>
			<div class="close-btn">
					完成 
			</div>
		</div>
		<div id="pay_list" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" type="wxpay" >
					<a href="#pay_list" ><span class="mui-icon mui-icon-weixin" style="color:#08AD13;margin-right:5px ;"></span>微信支付</a>
				</li>
				<li class="mui-table-view-cell" type="alipay">
					<a href="#pay_list" ><span class="mui-icon-extra mui-icon-extra-alipay" style="font-size: 20px;"></span>
						支付宝支付</a>
				</li>
				<!--<li class="mui-table-view-cell" type="hdfk">
					<a href="#pay_list" >货到付款</a>
				</li>-->
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" type="cansel">
					<a href="#pay_list" style="color: #999;" >取消</a>
				</li>
			</ul>
		</div>
		<nav class="mui-bar mui-bar-tab footer-bar" id="footerBar">
			<div class="heji fl">
				<span>应付金额:</span>
				<span id="amount">￥0</span>
			</div>
			<div class="fr" id="submit">
				<span class="submit-btn">提交订单</span>
			</div>
		</nav>
    <script type="text/javascript" src="../js/mui.min.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/common.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/mui.lazyload.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/mui.lazyload.img.js" charset="UTF-8"></script>
    <script type="text/javascript">
    	(function(win, $, h, ms) {
			$.init();
			h.d = {
				list: document.getElementById('buy-list'),
				amount: document.getElementById('amount'),
				_submit: document.getElementById('submit'),
				_address: document.getElementById('address'),
				_ps: document.getElementById('xz_peisong'),
				psfs: document.getElementById('psfs'),
				xz_quan: document.getElementById('xz_quan'),
				quan: document.getElementById('quan'),
				sum_amount: document.getElementById('sum_amount'),
				sum_ps: document.getElementById('sum_ps'),
//				ye: document.getElementById('ye'),
//				jf: document.getElementById('jf'),
				qm: document.getElementById('qm'),
				blance: document.getElementById('blance'),
				point: document.getElementById('point'),
				coupon: document.getElementById('coupon'),
				quan_list: document.getElementById('quan-list'),
				yhq: document.getElementById('yhq'),
				address_list: document.getElementById('address-list'),
				address: document.getElementById('address'),
				user_address: document.getElementById('user-address'),
				xz_fdbs: document.getElementById('xz_fdbs'),
				shops_fdbs: document.getElementById('shops-fdbs'),
				fdbs_list: document.getElementById('fdbs-list'),
				fdbs: document.getElementById('fdbs'),
				peisong:document.getElementById('peisong'),
				discount:document.getElementById('discount'),
				discount_txt:document.getElementById('discount_txt'),
				bz_txt:document.getElementById('textarea'),
				pay_list:document.getElementById('pay_list'),
				warm:document.getElementById('warm'),
			}
			h.order = {}
			h._submit={
				success:false,//提交成功
				status:false//提交状态
			}
			h.pay_type='wxpay';
			h.address_list = null;
			h.discount=100;
			h.pslist = [{
				id: 1,
				name: '配送到家'
			}, {
				id: 2,
				name: '门店自取'
			}]
			h.getPeisongfs = function() {
				var li = [];
				$.each(h.pslist, function(i, v) {
					if(i == 0) {
						h.psfs = v.id
					}
					li.push('<li class="mui-table-view-cell" psid="' + v.id + '">' + v.name + '</li>')
				})
				h.d.psfs.innerHTML = li.join('')
//				h.d.xz_fdbs.style.display="none"
			}
			/**
			 * 获取购物流程配置
			 */
			h.getShopConfig = function() {
				$.ajax(h.apiurl, {
					data: {
						m: 'get_config'
					},
					type: 'post',
					dataType: 'json',
					success: function(ret) {
						if(ret.code == 0 && ret.data) {
							var config = ret.data.shopping;
							config.time=new Date().getTime();
							h.config = {};
							$.each(config, function(i, v) {
								h.config[v.name] = v.value;
							});
							ms.setItem('conf_shopping', h.config)
							h.d.warm.querySelector('#freight_free').innerText=h.config.freight_free;
							h.d.warm.querySelector('#ps-hour').innerText=h.config.ps_hour||2;
						} else {
//							$.toast('获取配置失败')
						}
					},
					error: function(ret) {
//						alert(ret.responseText)
//						$.toast('获取配置异常')
					}
				})
			}
			/**
			 * 显示订单商品列表 
			 * @param {Object} data
			 */
			h.showItemList = function(data) {
				var html = [];
				h._sum = {
					amount: 0,
					exchange_integral: 0,
//					ladder_amount:0,
//					discount_amount:0,
					is_free_shipping:true
				}
				if(data.length > 0) {
					$.each(data, function(i, v) {
//						v.member_price=honey.fmoney(h.discount*parseFloat(v.price)/100);
						if(h._sum.is_free_shipping && parseInt(v.is_free_shipping)==0){
							h._sum.is_free_shipping=false
						}
						var price=v.price;
						//检查价格阶梯
//						var ladder_price=false;
			    		if(v.num>0&&v.price_ladder&&v.price_ladder.length>0){
			    			mui.each(v.price_ladder,function(j,val){
			    				if(v.num>=val.amount){
			    					price=val.price;
//			    					ladder_price=honey.fmoney(parseFloat(val.price)*h.discount/100)
			    				}
			    			})
			    		}
//			    		if(v.member_price<v.price){
//			    			h._sum.discount_amount=honey.fmoney(v.price-v.member_price)*parseFloat(v.num);
//			    		}
//			    		if(ladder_price && parseFloat(ladder_price)<parseFloat(v.member_price)){
//			    			h._sum.ladder_amount+=parseFloat(honey.fmoney((v.member_price-ladder_price)*parseFloat(v.num)));
//			    		}
						h._sum.amount +=price*100*v.num/100;
//						alert(h._sum.amount)
//						h._sum.amount += parseFloat(parseFloat(price*100*v.num/100).toFixed(2));
						if(v.exchange_integral) {
							h._sum.exchange_integral += parseInt(v.exchange_integral) * parseFloat(v.num)
						}
						var li = '<li><div class="goods-img fl"><img data-lazyload="' + v.img + '"></div>\
			                <div class="goods-info fl"><p class="title">' + h.cutstr(v.name, 50) + '</p>\
			                    <p class="weight">' + (v.spec_name ? v.spec_name.join('  ') : '') + '</p></div>\
			                <div class="price-num fr"><p class="price">\
			                        <span>￥</span><span>' + price + '</span></p><p>\
			                		<span>×</span><span>' + v.num + '</span></p></div></li>';
						html.push(li)
					});
				}
				h.d.list.innerHTML = html.join('')
				$('#buy-list').imageLazyload({
					placeholder:'../images/default.png',
				})
				h.d.warm.querySelector('#free').style.display=(h._sum.amount>h.config.freight_free?"none":"block");
			}
			/**
			 * 显示金额明细与应付金额
			 */
			h.showPayAmount = function() {
				h.d.sum_amount.innerText = "￥" + h.fmoney(h._sum.amount)
				h.pay_amount = h._sum.amount;
				//折扣优惠
				h.discount_money=h.discount<100?h.fmoney(h._sum.amount*(100-h.discount)/100):0;
				h.d.discount.innerText="-￥"+h.discount_money;
				if(h.discount_money>0 || h.discount<100){
					h.d.discount_txt.innerText="("+h.discount+"折)";
				}else{
					h.d.discount_txt.innerText='(无)'
				}
				h.pay_amount-=h.discount_money;
//				价格阶梯
//				h.d.ladder.innerText="-￥"+honey.fmoney(h._sum.ladder_amount);
//				h.pay_amount-=h._sum.ladder_amount;
				//是否满足免费配送
				//				alert(JSON.stringify(h.c?onfig))
				var psf = 0;
				if(h.psfs == 1) { //送货上门
					//不免运费或者未满足要求或者未选择门店或收货地址或者不在配送范围内
					if(!h._sum.is_free_shipping &&(h.config.freight_free == 0 || h.config.freight_free > h._sum.amount )) {//|| !h.fdbs || !h.order.address || h.fdbs.district_id != h.order.address.district
						psf = h.config.freight_money||10
					}
				}
				h.pay_amount += psf;
				h.d.sum_ps.innerText = "￥" + (psf > 0 ? h.fmoney(psf) : 0);
				//使用优惠券
				if(h.order.quan_code && h.order.quan_code > 0) {
					//券码
					h.pay_amount -= (h.order.quan_code > h.pay_amount ? h.pay_amount : h.order.quan_code)
					h.d.coupon.innerText = "-￥" + h.fmoney(h.order.quan_code)
					h.d.yhq.innerText = '不使用优惠券';
				} else if(h.order.quan && h.order.quan.money > 0) {
					//优惠券
					var money = parseFloat(h.order.quan.money)
					h.d.qm.value = ''
					h.d.yhq.innerText = money + '元优惠券';
					h.d.coupon.innerText = "-￥" + h.fmoney(money)
					h.pay_amount -= (money > h.pay_amount ? h.pay_amount : money)
				} else {
					h.d.coupon.innerText = "-￥0";
				}
				//使用积分
				h._points=h.user.pay_points;
				if(h._sum.exchange_integral > 0){
					if(h._points>h._sum.exchange_integral){
						h._points=h._sum.exchange_integral;
					}
//				if(h.d.jf.value > 0) {
					var totalPayPoint = h.pay_amount * h.config.point_rate;
					if(h._points > totalPayPoint) {
						h._points = totalPayPoint
					}
					h.use_jf = h.fmoney(parseInt(h._points) / parseFloat(h.config.point_rate));
					h.pay_amount -= h.use_jf;
					h.d.point.innerText = "-￥" + h.use_jf;
				} else {
					h._points=0;
					h.d.point.innerText = "-￥0";
				}
				//使用余额
				h._ye=h.user.user_money;
				if( h._ye> 0) {
					if(h._ye > h.pay_amount) {
						h._ye=h.pay_amount
					}
//					h.d.ye.value=h.fmoney(ye)
					h.pay_amount -= h._ye;
					h.d.blance.innerText = "-￥" + h.fmoney(h._ye)
				} else {
					h.d.blance.innerText = "-￥0"
				}
				h.d.amount.innerText = "￥" + h.fmoney(h.pay_amount > 0 ? h.pay_amount : '0.00');
			}
			/**
			 * 获取优惠券列表
			 */
			h.getCouponList = function() {
				h.coupon = []
				$.ajax(h.apiurl, {
					data: {
						m: 'get_coupon_list',
						token: ms.getItem('token')
					},
					type: 'post',
					dataType: 'json',
					success: function(ret) {
						if(ret.code == 0) {
							if(ret.data && ret.data.length > 0) {
								var list = [];
								var time = new Date().getTime() / 1000;
								h.coupon = ret.data;
								$.each(ret.data, function(i, v) {
									if(v.use_start_time <= time && v.use_end_time > time && h._sum.amount >= v.condition) {
										list.push('<div class="quan"><div class="quan-con"><div class="fl title">' +
											'<p class="number"><font>' + parseFloat(v.money) + '</font><span>元(满' + parseFloat(v.condition) + '元可用)</span></p>' +
											'<p class="use-time">有效期至：' + h.getYmdTime(v.use_end_time) + '</p>' +
											'</div><div class="fr getquan"><p class="use-quan" i="' + i + '">立即使用</p></div></div></div>');
									}
								});
								if(list.length > 0) {
									h.d.quan_list.innerHTML = list.join('')
								} else {
									h.d.quan_list.innerHTML = '<div class="no-quan">没有可用的券</div>';
								}
							}
						} else {
							if(ret.code == -1) {
								$.toast(ret.msg)
								honey.openWin('../mine/login.html', 'login')
								return
							}
							h.d.quan_list.innerHTML = '<div class="no-quan">没有可用的券</div>';
						}
					},
					error: function(ret) {
						//						$.toast('优惠券读取失败')
					}
				});
			}
			/**
			 * 获取收货地址列表
			 */
			h.getAddressList = function() {
				$.ajax(h.apiurl, {
					type: "post",
					async: true,
					dataType: 'json',
					data: {
						m: 'address_list',
						token: myStorage.getItem('token')
					},
					success: function(ret) {
						if(ret.code == 0) {
							h.address_list = ret.data;
						}
						h.showAddressList(h.address_list)
					},
				});
			}
			
			
			/**
			 * 选择收货地址
			 * @param {Object} v
			 */
			h.selectAddress = function(v) {
				h.order.address = v;
				if(v) {
//					var address = h.getAddressText(v, h.cityData) + v.address;
					h.d.address.querySelector('.user').innerHTML = '<p><span class="name">收货人：' + v.consignee + '</span>\
							<span class="phone">电话：' + v.mobile + '</span></p>\
							<p class="address">位置：' + v.name + '</p>';
					h.getDistance();
					h.showShopList()
//					if(v.city_id==360700){
//						h.showShopList()
////						h.getShopList()
//					}else{
//						h.d.warm.querySelector('#out-ps').style.display="block"
//						h.d.xz_fdbs.style.display="none";
//					}
				} else {
					h.d.address.querySelector('.user').innerHTML = '<p id="no-address">添加收货地址</p>';
				}
				h.showPayAmount()
			}
			/**
			 * 显示收货地址列表
			 * @param {Object} data
			 */
			h.showAddressList = function(data) {
				var _default;
				if(data && data.length > 0) {
					var html = []
					_default = data[0];
					$.each(data, function(i, v) {
//						var address = h.getAddressText(v, h.cityData) + v.address;
						if(v.is_default > 0) {
							_default = v;
						}
						html.push('<div class="address-item" address_id="' + v.address_id + '">\
		                		<p><span class="name">收货人：' + v.consignee + '</span>\
									<span class="phone">电话：' + v.mobile + '</span>\
								</p><p class="address">位置：' + v.name + '</p>\
								<p class="icon">\
									<span class="mui-icon mui-icon-arrowright"></span>\
								</p></div>')
					});
					h.d.address_list.innerHTML = html.join('')
				} else {
					h.d.address_list.innerHTML = ''
				}
				h.selectAddress(_default)
			}
			/**
			 * 获取门店列表
			 */
			h.getShopList = function(district) {
				$.ajax(h.apiurl, {
					type: "post",
					async: true,
					dataType: 'json',
					data: {
						m: 'shop_list',
						district: district
					},
					success: function(ret) {
						h.shop_list = ret.data;
						var html=['<div class="no-fdbs" id="no-fdbs" style="display:none">您附近没有可选的门店</div>'];
						$.each(h.shop_list, function(i, v) {
							html.push('<div class="fdbs-item" id="'+v.shop_fdbs+'" shop_id="' + v.shop_id + '">\
		                		<p class="shop_name"><img src="../images/fdbs.png" height="15" /> ' + v.shop_name + '<font class="fr"></font></p>\
		                		<p class="phone">电话：<font>'+v.phone+'</font><img src="../images/call.png" width="12" /></p><p class="shop_address">位置：' + v.shop_address + '</p></div>')
						});
						h.d.fdbs_list.innerHTML = html.join('')
//						h.showShopList(ret.data || false)
					},
					error: function(ret) {
//						h.showShopList()
					}
				});
			}
			/**
			 * 显示门店列表
			 * @param {Object} data
			 */
			h.showShopList = function() {
				h.fdbs = null;
				h.d.fdbs.innerText =h.psfs==1? "友邦大药房":"请选择门店";
				if(h.shop_list && h.shop_list.length > 0) {
					var tag=false;
					$.each(h.shop_list, function(i, v) {
						var o=document.getElementById(v.shop_fdbs);
						if(v.city_id==h.order.address.city_id){
							o.style.display="block"; 
							tag=true;
						}else{
							o.style.display="none";
						}
					});
					if(tag){
						h.d.warm.querySelector('#out-ps').style.display="none";
						document.getElementById('no-fdbs').style.display="none";
						h.showDistance();
						return
					}
//					h.getDistance(point)
				}
				if(h.psfs==1){
//					h.d.fdbs.innerText = "友邦大药房";
					h.d.warm.querySelector('#out-ps').style.display="block";
					document.getElementById('no-fdbs').style.display="block";
				}
//				h.d.fdbs_list.innerHTML = '<div class="no-fdbs">您附近没有可选的门店</div>';
			}
			
			/*
			 * 自动按距离排序门店
			 */
			h.sortIntoDistanceArr=function(distance,distanceArr){
				var lt=[],gt=[];
				if(distanceArr.length==0){
					return [distance];
				}
				for(var i=0;i<distanceArr.length;i++){
					if(parseFloat(distance[0])<=parseFloat(distanceArr[i][0])){
						lt.push(distance);
					}else{
						gt.push(distance);
					}
				}
				if(lt.length==0){
					distanceArr.push(distance)
					return distanceArr;
				}
				var arr=[];
				for(var i=0;i<lt.length;i++){
					arr.push(lt[i])
				}
				for(var i=0;i<gt.length;i++){
					arr.push(gt[i])
				}
				return arr;
			}
			
			/**
			 * 显示距离
			 * @param {Object} address
			 */
			h.showDistance=function(address){
				if(!address){
					for(var i=0;i<h.address_list.length;i++){
						if(h.address_list[i].address_id==h.order.address.address_id){
							address=h.address_list[i];
							break;
						}
					}
				}
				if(address&&address.distance){
					var arr=[];
					$.each(address.distance, function(i,v) {
						var obj=document.getElementById(v.fdbs);
						obj.setAttribute('distance',v.distance.value)
						obj.querySelector('.fr').innerText=v.distance.text;
						h.d.fdbs_list.removeChild(obj);
						arr=h.sortIntoDistanceArr([v.distance.value||99999999,obj],arr)
					});
					var div=h.d.fdbs_list.querySelector('.fdbs-item');
					$.each(arr, function(i,v) {
						h.d.fdbs_list.insertBefore(v[1],div)
					});
				}
			}
			/**
			 * 计算距离
			 */
			h.getDistance=function(){
				var addr=[];
				var is_show=false;
				for(var i=0;i<h.address_list.length;i++){
					var v=h.address_list[i];
					if(!v.distance){
						addr.push({jd:v.jd,wd:v.wd,address_id:v.address_id,index_:i});
					}else{
						if(v.address_id==h.order.address.address_id){
							h.showDistance(v)
							return
						}
					}
				}
				var origins=[],destinations=[];
				$.each(addr, function(i,v) {
					origins.push(v.wd+','+v.jd)
				});
				var point=[];
				$.each(h.shop_list, function(i,v) {
					if(v.jd>0){
						point.push({jd:v.jd,wd:v.wd,fdbs:v.shop_fdbs,index_:i})
						destinations.push(v.wd+','+v.jd);
					}
				});
				origins=origins.join('|');
				destinations=destinations.join('|');
				$.ajax('http://api.map.baidu.com/routematrix/v2/riding',{
					type:"get",
					async:true,
					dataType:'json',
					data:{
						origins:origins,
						destinations:destinations,
						output:'json',
						tactics:11,
						ak:'7M8ZsypQKQAw2TjtLfcTyvofu9NMrSdu',
					},
					success:function(ret){
//						console.log(ret)
//						alert(ret)
						if(ret.status==0){
							var index=0;
							$.each(ret.result, function(i,v) {
								var n=i%point.length;
								if(i>0&&n==0){
									index++;
								}
								var addr_n=addr[index].index_;
								if(!h.address_list[index].distance){
									h.address_list[index].distance=[];
								}
								h.address_list[addr_n].distance.push({fdbs:point[n].fdbs,distance:v.distance,duration:v.duration})
							});
							h.showDistance();
//							console.log(JSON.stringify(addr))
						}
					},
					error:function(ret){
//						alert(ret.responseText)
						
					}
				});
			}
			$.plusReady(function() {
				h.user=myStorage.getItem('user')
	    		if(h.user&&h.user.level.discount>0){
	    			h.discount=parseInt(h.user.level.discount);
	    			if(h.discount>100){
	    				h.discount=100
	    			}
	    		}
	    		h.cartContent=plus.webview.getWebviewById('cart-content');
	    		h.mineWin=plus.webview.getWebviewById('mine');
	    		h.buyWin=plus.webview.getWebviewById('buy');
	    		h.goodsHeader=plus.webview.getWebviewById('goods-header');
				h.fixFooter()
				h.getchannel()
				h.getPeisongfs()
				h.getShopList()
				
				/**
				 * 输入优惠券码事件
				 */
				h.d.qm.addEventListener('change', function() {
					var that = this;
					var code = that.value;
					if(code.length == 8) {
						$.ajax(h.apiurl, {
							data: {
								m: 'check_coupon_code',
								code: code,
								amount: h._sum.amount
							},
							type: 'post',
							dataType: 'json',
							success: function(ret) {
								if(ret.code == 0) {
									h.order.quan_code = parseFloat(ret.data.result)
									h.order.quan = false
									h.showPayAmount()
								} else {
									if(ret.code == -9) {
										that.value = ''
									}
									$.toast(ret.msg)
								}
							},
							error: function(ret) {
								$.toast('优惠券读取失败')
							}
						});
					} else {
						if(h.order.quan_code) {
							h.order.quan_code = 0
							h.showPayAmount()
						}
						that.value = ''
						$.toast('优惠券码不存在')
					}
				})
		
				/**
				 * 提交订单
				 */
				h.d._submit.addEventListener('tap', function() {
					if(h._submit.status){
					    $.toast('数据提交中..')
						return
					}
					if(h._submit.success){//已提交成功关闭当前页面
						$.toast('订单已提交成功')
						$.back()
						return
					}
					//检测数据订单数据
					if(h.psfs == 1 && (!h.order.address|| !h.order.address.address_id)) {
						$.toast('未选择收货地址')
						return
					}
					if(h.psfs ==2 &&!h.fdbs) {
						$.toast('请选择门店')
						return
					}
					h._submit.status=true;
					plus.nativeUI.showWaiting('正在提交订单...')
					$.ajax(h.apiurl, {
						type: "post",
						dataType: 'json',
						async: true,
						data: {
							m: 'add_order',
							token: h.token,
							goods: h.goods,
							address_id: h.order.address.address_id,
							use_money: h._ye,
							use_point: h._points,
							quan_code: h.d.qm.value,
							quan_id: h.order.quan?h.order.quan.id:0,
							beizhu:h.d.bz_txt.value,
							pay_amount:h.pay_amount,
							discount_money:h.discount_money,
							psfs:h.psfs,
							shop_id:h.fdbs?h.fdbs.shop_id:0,
							pay_type:h.pay_type,
							distance:h.distance
						},
						success: function(ret) {
							if(ret.code==0){//订单提交成功,开始支付
								h._submit.success=true;
								h.order_id=ret.order_id
								$.toast('订单提交成功');
								//删除购物车包含订单中的商品
								cart=h.update_cart(ms.getItem('cart'),h.goods,'delete')
								if(cart.length>0){
									ms.setItem('cart',cart)
								}else{
									ms.removeItem('cart')
								}
								h.countCartGoodsNum(cart)
								//提交成功，跳转支付
								if(h.pay_amount>0){
									$(h.d.pay_list).popover('toggle')
								}else{
									h.orderSuccess();
								}
							}else{
								console.log(JSON.stringify(ret))
								$.toast(ret.msg||'订单提交失败')
								switch(ret.code){
									case 2:
										//获取购物车中的商品
										var cart=ms.getItem('cart');
										if(ret.data){
											if(ret.data.not_find&&ret.data.not_find.length>0){
												//商品不存在（已过期）
												cart=h.update_cart(cart,ret.data.not_find,'not_find')
											}
											if(ret.data.off_sale&&ret.data.off_sale.length>0){
												//商品已下架
												cart=h.update_cart(cart,ret.data.off_sale,'off_sale')
											}
											if(ret.data.store_nomore&&ret.data.store_nomore.length>0){
												//库存不足，更新库存
												cart=h.update_cart(cart,ret.data.store_nomore,'store_nomore')
											}
											//更新购物车
											ms.setItem('cart',cart)
											setTimeout(function(){
												$.fire(h.cartContent,'showCart'); 
											},500)
											
										}
										break;
									case 3://提交失败，更新配置参数
										h.getShopConfig()
										//更新用户信息
										$.fire(plus.webview.getWebviewById('mine'),'login')
										break;
									default:
										return;
								}
								//关闭当前订单
								$.back()
							}
						},
						error: function(ret) {
							h._submit.status=false;
							alert(ret.responseText)
//							alert(JSON.stringify(ret))
//							$.toast('error')
						}
					});
					//	    			setTimeout(function(){
					plus.nativeUI.closeWaiting()
//					alert('aa')
					//	    			},200)
				})
				
				/**
				 * 返回修改后的购物车数据
				 * @param {Array} cart
				 * @param {Array} items
				 * @param {string} type
				 */
				h.update_cart=function(cart,items,type){
					if(!cart){
						return [];
					}
					$.each(items,function(i,v){
						for(var j=0;j<cart.length;j++){
							if(v.goods_id==cart[j].goods_id){
								if((!cart[j].spec_key && !v.spec_key) || (cart[j].spec_key && v.spec_key && cart[j].spec_key==v.spec_key)){
//								if(((!v.spec_key||v.spec_key=='undefined')&&(!cart[j].spec_key||cart[j].spec_key=='undefined'))||v.spec_key==cart[j].spec_key){
									switch(type){
//										case 'not_find':
//										case 'off_sale':
//											cart[j][type]=true;
//										break;
										case 'store_nomore'://库存不足
											cart[j].num=v.max_store;
								    		if(cart[j].num>0&&cart[j].price_ladder&&cart[j].price_ladder.length>0){
								    			$.each(cart[j].price_ladder,function(k,val){
								    				if(cart[j].num>=val.amount){
				//				    					honey.cart[i].ladder_price=honey.fmoney(val.price*honey.discount/100)
								    					cart[j].ladder_price=val.price
								    				}
								    			})
								    		}
										break;
										case 'not_find':
										case 'off_sale':
										case 'delete':
											//删除商品
    										cart.splice(j,1)
										break;
									}
									break
								}
							}
						}
					})
					return cart;
				}
				
				h.orderSuccess=function(){
					//跳转到订单详情并关闭当前页
					h.openWin('../mine/order-detail.html','order-detail',{order_id:h.order_id})
					setTimeout(function(){
						$.fire(h.cartContent,'showCart');
						$.fire(h.mineWin,'reloadUser')
						h.buyWin.hide()
					},500)
				}
				
				
		
				/**
				 * 初始化提交订单页面
				 */
				win.addEventListener('showBuyList', function(o) {
					h.token = ms.getItem('token')
					h.user = ms.getItem('user')
					h.user.ye = parseFloat(h.user.user_money) - parseFloat(h.user.frozen_money);
//					h.d.ye.value=h.user.ye || 0;
//					h.d.jf.value=h.user.pay_points || 0
//					h.d.ye.setAttribute('placeholder', '您的当前余额为' + (h.user.ye || 0))
//					h.d.jf.setAttribute('placeholder', '您的当前积分为' + (h.user.pay_points || 0))
//					h.d.ye.blur()
//					h.d.jf.blur()
					h.d.qm.blur()
//					h.d.ye.value = ""
//					h.d.jf.value = ""
					h.d.qm.value = ""
					h.mySrcollTo('content')
					h.d.yhq.innerText = '不使用优惠券';
					h.d.peisong.innerText = honey.pslist[0].name
					h.order = {}
					h.d._address.setAttribute('style', '')
					h.showItemList(h.goods = o.detail)
					h.showPayAmount()
					h.getCouponList()
					h.getAddressList()
//					h.getPeisongfs()
					h._submit={
						success:false,//提交成功
						status:false//提交状态
					}
				})
		
				win.addEventListener('reloadAddress', function() {
					h.getAddressList()
				})
				
				win.addEventListener('logout',function(){
					h.discount=100;
				})
				
				win.addEventListener('login',function(){
					h.user=myStorage.getItem('user')
		    		if(h.user&&h.user.level.discount>0){
		    			h.discount=parseInt(h.user.level.discount);
		    			if(h.discount>100){
		    				h.discount=100
		    			}
		    		}
				})
		
				var nowTime = new Date().getTime();
				h.config = ms.getItem('conf_shopping')
				if(!h.config || !h.config.time || nowTime - h.config.time > 7200000) { //3小时更新一次
					h.getShopConfig()
				}else{
					h.d.warm.querySelector('#freight_free').innerText=h.config.freight_free;
					h.d.warm.querySelector('#ps-hour').innerText=h.config.ps_hour||2;
				}
		
				/**
				 * 打开门店列表
				 */
				h.d.xz_fdbs.addEventListener('tap', function() {
					$(h.d.shops_fdbs).popover('toggle')
					$('#shop-wrapper').scroll().scrollTo(0, 0, 0)
				})
				/**
				 * 选择地址
				 */
				$(h.d.address_list).on('tap', '.address-item', function() {
					var address_id = this.getAttribute('address_id')
					for(var i = 0; i < h.address_list.length; i++) {
						if(h.address_list[i].address_id == address_id) {
							h.selectAddress(h.address_list[i])
							break;
						}
					}
					$(h.d.user_address).popover('toggle')
				})
		
				/**
				 * 选择门店
				 */
				$(h.d.shops_fdbs).on('tap', '.shop_name', function() {
					var p=this.parentElement;
					var shop_id = p.getAttribute('shop_id');
					h.distance= p.getAttribute('distance');
					if(!h.config.distance){
						h.config.distance=2000;
					}
					if(!h.distance || parseFloat(h.distance)>h.config.distance){
						if(h.psfs==1){
							h.d.warm.querySelector('#out-ps').style.display="block";
						}
					}else{
						h.d.warm.querySelector('#out-ps').style.display="none"; 
					}
					for(var i = 0; i < h.shop_list.length; i++) {
						if(shop_id == h.shop_list[i].shop_id) {
							h.fdbs = h.shop_list[i];
							h.d.fdbs.innerText = h.fdbs.shop_name;
							break;
						}
					}
					$(h.d.shops_fdbs).popover('toggle')
					h.showPayAmount()
				})
				
				$(h.d.shops_fdbs).on('tap', '.phone', function() {
					var phone=this.querySelector('font').innerText;
					phone=phone.replace(/[^0-9]/g,'');
					if(phone){
						$.confirm(phone,'拨号提示',['拨号','关闭'],function(e){
							if(e.index==0){
								h.call(phone) 
							}
						})
						
					}
				})
//				h.call = function(number) {
//			        if(plus.os.name=="Android"){
//			            var Intent = plus.android.importClass("android.content.Intent");
//			            var Uri = plus.android.importClass("android.net.Uri");
//			            var main = plus.android.runtimeMainActivity();
//			            var uri = Uri.parse("tel:"+number);
//			            var call = new Intent("android.intent.action.CALL", uri);
//			            main.startActivity(call);
//			        }else{
//			            //plus.device.dial(number, false);
//			            var UIAPP=plus.ios.importClass("UIApplication");
//			            var NSURL=plus.ios.importClass("NSURL");
//			            var app=UIAPP.sharedApplication();
//			            app.openURL(NSURL.URLWithString("tel://"+number));
//			        }
//			    }
				/**
				 * 选择收货地址
				 */
				h.d._address.addEventListener('tap', function() {
					if(h.address_list && h.address_list.length > 0) {
						$(h.d.user_address).popover('toggle')
						$('#address-wrapper').scroll().scrollTo(0, 0, 0)
						h.showPayAmount()
					} else {
						h.openWin('../mine/address.html', 'address', {
							frompage: 'buy-content'
						})
					}
		
				})
		
				/**
				 * 打开配送方式列表
				 */
				h.d._ps.addEventListener('tap', function() {
					if(h.order.address.city_id==360700){
						$('#peisongfs').popover('toggle');
					}
					
				})
		
				/**
				 * 选择配送方式
				 */
				$('.psfs').on('tap', 'li', function() {
					var psid = this.getAttribute('psid');
					if(!h.psfs || h.psfs != psid) {
						h.psfs = psid;
						h.d._address.setAttribute('style', h.psfs == 1 ? '' : 'display:none');
						h.d.peisong.innerText = this.innerText;
						h.fdbs=null;
						h.d.fdbs.innerText="请选择门店";
						if(h.psfs==2){
							h.d.warm.querySelector('#out-ps').style.display="none"; 
							h.d.warm.querySelector('#free').style.display="none"; 
//							h.d.fdbs.innerText="请选择门店"; 
//							h.d.xz_fdbs.style.display="block";
						}else{
							h.d.fdbs.innerText = "友邦大药房";
//							h.fdbs=null;
//							h.d.xz_fdbs.style.display="none";
						}
						//重新加载店铺列表
//						h.getShopList(-1)
						h.showPayAmount()
					}
					$(this.parentElement.parentElement).popover('toggle');
				})
				//	    		$('.mui-scroll-wrapper').scroll();
				//打开优惠券列表
				h.d.xz_quan.addEventListener('tap', function() {
					$(h.d.quan).popover('toggle')
					$('#quan-wrapper').scroll().scrollTo(0, 0, 0)
				})
		
				/**
				 * 使用优惠券
				 */
				$(h.d.quan_list).on('tap', '.use-quan', function() {
					var i = this.getAttribute('i')
					if(h._sum.amount >= h.coupon[i].condition) {
						h.order.quan = h.coupon[i]
						h.order.quan_code = 0
						h.showPayAmount()
					}
					$(h.d.quan).popover('toggle')
				})
				
				//选择支付方式
				$(h.d.pay_list).on('tap','li',function(){
					h.pay_type=this.getAttribute('type')
					if(h.pay_type=='cansel'){
						h.orderSuccess()
						return
					}
					var data={
						m:'pay_order',
						pay_type:h.pay_type,
						id:h.order_id,
						token:h.token
					}
					h.pay(data,function(ret){
						$.toast(ret.msg)
						h.orderSuccess()
					})
				})
		
				//关闭列表 
				$('.mui-popover').on('tap', '.close-btn', function() {
					$(this.parentElement).popover('toggle')
				})
		
			})
		
		}(window, mui, honey, myStorage))
    </script>
	</body>

</html>

