<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>product-detail</title>
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css"  />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/own.css" />
		<link rel="stylesheet" type="text/css" href="../css/previewimage.css" />
		<link rel="stylesheet" type="text/css" href="../css/goods-detail.css" />
	</head>
	<body id="body">
		<header class="mui-bar mui-bar-nav" id="header">
			<span class="active" index="1">商品</span> <span index="2">详情</span> <span index="3">评论</span> 
		</header>
		<div id="detailcontent" class="mui-content  detail-content-padding">
			<div id="attr">
				<div class="goods-title">
					<div class="fl title"><h5 id="goods_title">这里是标题这里是标题这里是这里是标题这里是标题这里是</h5></div>
					<div class="fr icon">
						<a href="#" id="share">
		                    <span class="mui-icon-extra mui-icon-extra-share fl"></span>
		                    <span class="fr">分享</span>
		            	</a>
					</div>
				</div>
				<div class="goods-attr">
					<div class="price">
						<p class="goods-price goods-price-one"><span class="icon-money">￥</span><span id="shop_price">200</span></p>
						<p class="goods-price goods-price-two" id="market_price">价格 <span>￥300</span></p>
					</div>
					<div class="express">
						<p>
							<span>快递:<font>0.00</font></span>
							<span style="text-align: center;">销量:<font id="sale_num">0</font>笔</span>
							<span style="text-align: right;">库存:<font id="store">0</font></span>
						</p>
					</div>
				</div>
				<div class="user-do choose-type" id="spec">
					<!--<p>
					<span>套餐</span>
					<button type="button" class="mui-btn mui-btn-active">
						套餐一
					</button>
					<button type="button" class="mui-btn">
						套餐二
					</button>
					<button type="button" class="mui-btn">
						套餐三
					</button>
					<button type="button" class="mui-btn">
						套餐四
					</button>
					</p>-->
				</div>
				<div class="user-do" id="buy-number">
					<span>数量</span>
					<div class="mui-numbox">
						<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
						<input class="mui-input-numbox" type="number" min="1" max="100" id="buy-num"/>
						<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
					</div>					
				</div>
				<div class="preferential">
					<div class="service" id="attr-express">
						<p><span class="mui-icon mui-icon-checkmarkempty"></span>配送到家</p>
						<p><span class="mui-icon mui-icon-checkmarkempty"></span>药店自取</p>
						<!--<p class="icon fr"><span class="mui-icon mui-icon-arrowright"></span></p>-->
					</div>
					<div class="service">
						<p class="point"><icon>积分</icon>购买可得<font id="give_integral">0</font>积分</p>
						<!--<p class="icon fr"><span class="mui-icon mui-icon-arrowright"></span></p>-->
					</div>
				</div>
				<div class="remark">
					<div class="attr-table">
						<div class="service">
							<p>产品简介</p>
							<!--<p class="icon fr"><span class="mui-icon mui-icon-arrowright"></span></p>-->
						</div>
					</div>
					<p id="remark">暂无简介
					</p>
				</div>
				<div class="parameter" id="param">
					<div class="attr-table">
						<div class="service">
							<p>产品参数</p>
							<!--<p class="icon fr"><span class="mui-icon mui-icon-arrowright"></span></p>-->
						</div>
						<table id="goods-attr-table">
						</table>
					</div>
				</div>
			</div>
			<div class="remark" id="goods-content">
				<div class="attr-table">
					<div class="service">
						<p>详情</p>
						<!--<p class="icon fr"><span class="mui-icon mui-icon-arrowright"></span></p>-->
					</div>
				</div>
				<div id="content-text">
				</div>
			</div>
			<div class="evaluate" id="evaluate">
				<div class="evaluate-title"><span class="mui-icon mui-icon-chatbubble"></span>评价(<span id="c0">0</span>)</div>
				<div class="evaluate-content">
					<ul class="evaluate-list" id="evaluate-list">
						<!--<li class="evaluate-list-item">
							<p>
								<span class="user-name"><img src="../images/profile.png"/><font>匿名用户</font></span>
								<span class="user-star">
									<i class="mui-icon mui-icon-star-filled"></i>
									<i class="mui-icon mui-icon-star-filled"></i>
									<i class="mui-icon mui-icon mui-icon-star-filled"></i>
									<i class="mui-icon mui-icon-star-filled"></i>
									<i class="mui-icon mui-icon-starhalf"></i>
								</span>
								<span class="user-time">2017-01-01</span>
							</p>
							<p>
								分管控了数据顾客零食就赶快来数据打开感动死了就接口里金刚骷髅岛技术更抗裂砂浆啊分管控了数据顾客零食就赶
								快来数据打开感动死了就接口里金刚骷髅岛技术更抗裂砂浆啊分管控了数据顾客零食就赶快来数据打开感动死了就
								接口里金刚骷髅岛技术更抗裂砂浆啊分管控了数据顾客零食就赶快来数据打开感动死了就接口里金刚骷髅岛技术
								更抗裂砂浆啊分管控了数据顾客零食就赶快来数据打开感动死了就接口里金刚骷髅岛技术更抗裂砂浆啊
							</p>
							<p>
								<div class="user-photo">
									<img class="photos" data-preview-src="" data-preview-group="2"  src="../images/muwu.jpg"/>
									<img class="photos" data-preview-src="" data-preview-group="2" src="../images/shuijiao.jpg"/>
								</div>
							</p>
						</li>-->
					</ul>
					<p class="evaluate-more" id="evaluate-more">查看全部评论</p>
				</div>
			</div>
		</div>
		<div id="no-content">
			<p><img src="../images/kuqi.png"/></p>
			<p id="no-content-text">很抱歉,此商品已下架或不存在!</p>
		</div>
		<nav class="mui-bar mui-bar-tab footer-bar">
			<a id="consult">
				<span class="mui-icon mui-icon-chat"></span>
				<span class="mui-tab-label">咨询</span>
			</a>
			<a id="collect">
				<span class="mui-icon mui-icon-star" id="collect-icon"></span>
				<span class="mui-tab-label">收藏</span>
			</a>
			<a class="add-cart">
				加入购物车
			</a>
			<a class="buy-now">
				立即购买
			</a>
		</nav>
		<script type="text/javascript" src="../js/mui.min.js" charset="UTF-8"></script>
		<script type="text/javascript" src="../js/common.js" charset="UTF-8"></script>
		<script type="text/javascript" src="../js/mui.lazyload.js" charset="UTF-8"></script>
		<script type="text/javascript" src="../js/mui.lazyload.img.js" charset="UTF-8"></script>
		<script type="text/javascript" src="../js/mui.zoom.js" charset="UTF-8"></script>
		<script type="text/javascript" src="../js/mui.previewimage.js" charset="UTF-8"></script>
		<script type="text/javascript" charset="UTF-8">
			mui.init({
				swipeBack: false,
			});
			var honey={
				d:{
					attrExpress:document.getElementById('attr-express'),
					id:document.getElementById('goods-id'),
					buyNum:document.getElementById('buy-num'),
					share:document.getElementById('share'),
					param:document.getElementById('param'),
					title:document.getElementById('goods_title'),//标题
					price:document.getElementById('shop_price'),//价格
					m_price:document.getElementById('market_price'),//市场价格
					spec:document.getElementById('spec'),//规格属性
					store:document.getElementById('store'),
					saleNum:document.getElementById('sale_num'),
					giveIntegral:document.getElementById('give_integral'),
					table:document.getElementById('goods-attr-table'),
					topSpan:document.getElementById('header').querySelectorAll('span'),
					topMenu:document.getElementById('header').querySelectorAll('span')[0],
					c0:document.getElementById('c0'),
					evaluate:document.getElementById('evaluate'),
					evaluateList:document.getElementById('evaluate-list'),
					evaluateMore:document.getElementById('evaluate-more'),
					header:document.getElementById('header'),
					remark:document.getElementById('remark'),
					goodsContent:document.getElementById('goods-content'),
					content:document.getElementById('content-text'),
					noContent:document.getElementById('no-content'),
					noContentTxt:document.getElementById('no-content-text'),
					detailcontent:document.getElementById('detailcontent'),
					collect:document.getElementById('collect'),
					consult:document.getElementById('consult'),
					collectIcon:document.getElementById('collect-icon')
				},
				goods:{},
				scrollMenu:true,
				ajaxGetData:function(){
					mui.ajax(apiurl,{
						data:{m:'goods_info',goods_id:honey.goods.goods_id},
						type:'post',
						dataType:'json',
						timeout:60000,
						success:function(ret){ 
							if(ret.code==0){
								//初始化显示
								honey.d.noContent.setAttribute('style','display:none')
								honey.d.header.setAttribute('style','')
								honey.d.detailcontent.setAttribute('style','')
								var data=ret.data;
								//标题
								honey.d.title.innerText=data.base.goods_name;
								//收藏
								data.collect==1&&honey.collectCallBack(1)
								//商品图片
								var img=[{src:apihost+data.base.original_img}];
								mui.each(data.images, function(i,v) {
									if(v.image_url!=data.base.original_img){
										img.push({src:apihost+v.image_url})
									}
								});
								honey.imageSliderView.setImages(img)
								honey.imageSliderView.show()
								//是否有规格属性
								if(data.spec){
									var price_key=[];
									var spec_html=[];
									mui.each(data.spec, function(i,v) {
										var html=[];
										for(var j=0;j<data.spec[i].length;j++){
											var v=data.spec[i][j];
											if(j==0){
												price_key.push(v.item_id)
											}
											html.push('<button type="button" item_id="'+v.item_id+'" class="mui-btn'+(j==0?' mui-btn-active':'')+'">'+v.item+'</button>');
										}
										spec_html.push('<p class="goods_spec"><span>'+i+'</span>'+html.join('')+'</p>')
									});
									var k=price_key.length>1?price_key.join('_'):price_key[0];
									honey.spec_price=data.spec_price;
									honey.d.price.innerText=honey.goods.price=honey.spec_price[k].price;//价格
									honey.d.store.innerText=honey.goods.store=honey.spec_price[k].store_count;//库存
									honey.d.spec.innerHTML=spec_html.join('');
									honey.d.spec.setAttribute('style','')
								}else{
									honey.d.spec.setAttribute('style','display:none')
									honey.d.price.innerText=honey.goods.price=data.base.shop_price;
									honey.d.store.innerText=honey.goods.store=data.base.store_count;
								}
								if(honey.goods.store==0){
									honey.d.buyNum.value=0
								}
								//销量
								honey.d.saleNum.innerText=data.base.sale_num;
								//积分
								honey.d.giveIntegral.innerText=data.base.give_integral;
								//产品参数
								var goodsAttr=[];
								mui.each(data.attr,function(i,v){
									goodsAttr.push('<tr><td>'+v.attr_name+'</td><td>'+v.attr_value+'</td></tr>');
								})
								honey.d.table.innerHTML=goodsAttr.join('');
								//评价
								if(data.comment){
									honey.commentMore=true;
									honey.d.evaluateMore.innerText="查看全部评价";
									data.comment.statistics&&(honey.d.c0.innerText=data.comment.statistics.c0);
									data.comment.list&&showCommentList(data.comment.list,'evaluate-list');
								}else{
									honey.commentMore=false;
									honey.d.c0.innerText=0;
									honey.d.evaluateMore.innerText="此商品暂无评价";
								}
								//简介
								honey.d.remark.innerText=data.base.goods_remark;
								//详情
								data.base.goods_content=escape2Html(data.base.goods_content)
								honey.d.content.innerHTML=data.base.goods_content;
								var img=honey.d.content.querySelectorAll('img');
								if(img.length>0){
									mui.each(img, function(i,v) {
										var s=apihost+v.getAttribute('src')
										v.setAttribute('src',s)
										v.setAttribute('data-preview-src',s)
										v.setAttribute('data-preview-group','content');
									});
									mui('#content-text').off('tap','img').on('tap','img',function(){
										mui.previewImage()
									})
								}
							}else if(ret.code==2){//商品不存在或以下架
								honey.getDataFailed()
							}
						},
						error:function(ret){
							alert(JSON.stringify(ret))
							honey.getDataFailed(1)
						} 
					})
				},
				getDataFailed:function(err){
					honey.d.noContentTxt.innerText=err==1?"很抱歉,网络不给力,请检查网络!":"很抱歉,此商品已下架或不存在!";
					honey.d.noContent.setAttribute('style','')
					honey.imageSliderView.hide()
					honey.d.header.setAttribute('style','display: none;')
					honey.d.detailcontent.setAttribute('style','display: none;')
				},
				collectCallBack:function(is_true){
					honey.d.collectIcon.setAttribute('class',is_true?'mui-icon mui-icon-star-filled has-collect':'mui-icon mui-icon-star')
				}
			};
			mui.plusReady(function(){
				honey.token=getStorage('token')
				/**
				 * 分享事件
				 */
				honey.d.share.addEventListener('tap',function(){
					mySrcollTo('evaluate',1,1)
				})
				
				/**
				 * 查看更多评论
				 */
				honey.d.evaluateMore.addEventListener('tap',function(){
					if(honey.commentMore){
						alert('more')
					}
				})
				
				honey.d.collect.addEventListener('tap',function(e){
					if(!honey.token){
						honey.token=getStorage('token')
						if(!honey.token){
							openWin('../mine/login.html','login')
							e.stopPropagation();
						}
						return
					}
					mui.ajax(apiurl,{
						data:{m:'collect_goods',goods_id:honey.goods.goods_id,token:honey.token},
						type:'post',
						dataType:'json',
						timeout:60000,
						success:function(ret){
							mui.toast(ret.msg)
							if(ret.code==0){
								honey.collectCallBack(ret.type==1)
							}
						},
						error:function(ret){
//							alert(JSON.stringify(ret))
//							mui.toast('失败')
						}
					})
				})
				
				/**
				 * 头部菜单事件
				 */
				mui('#header').on('tap','span',function(){
					honey.d.topMenu.className='';
					this.className="active";
					honey.d.topMenu=this;
					var index=this.getAttribute('index');
					switch(index){
						case '1'://回到顶部
							mySrcollTo()
							break;
						case '2'://详情
							mySrcollTo('goods-content')
							break;
						case '3'://评论
							mySrcollTo('evaluate')
							break;
					}
				})
				
				/**
				 * 选择规格事件
				 */
				mui('.choose-type').on('tap','.mui-btn',function(){
					//判断是否已选择
					if(!this.hasClass('mui-btn-active')){
						var p=this.parentElement.querySelectorAll('.mui-btn-active')[0];
						this.classList.add('mui-btn-active')
						p.classList.remove('mui-btn-active')
						var btn=mui('.mui-btn-active');
						var price_key=[];
						mui.each(btn, function(i,v) {
							price_key.push(v.getAttribute('item_id'))
						});
						var k=price_key.length>1?price_key.join('_'):price_key[0];
						honey.goods.price=honey.spec_price[k].price;//价格
						honey.goods.store=honey.spec_price[k].store_count;//库存
						honey.d.price.innerText=honey.goods.price;
						honey.d.store.innerText=honey.goods.store;
						if(honey.d.buyNum.value<honey.goods.store){
							honey.d.buyNum.value==0&&(honey.d.buyNum.value=1);
						}else{
							honey.d.buyNum.value=honey.goods.store;
						}
					}
				})
				
				/**
				 * 选择数量事件
				 */
				honey.d.buyNum.addEventListener('change',function(){
					if(this.value<1){
						this.value=1
					}
					if(this.value>honey.goods.store){
						this.value=honey.goods.store
						if(honey.goods.store==0){
							mui.toast('该商品已售罄')
						}
					}
				})
				
				honey.d.attrExpress.addEventListener('tap',function(){
					plus.webview.currentWebview().setStyle({
						mask: "rgba(0,0,0,0.5)"
					});
					if(!honey.servicePage){
						honey.servicePage=plus.webview.getWebviewById('service');
					}
					honey.servicePage.show('slide-in-bottom',300)
				})
				
				/**
				 * 显示商品事件
				 */
				window.addEventListener('showGoods',function(o){
					honey.goods.goods_id=o.detail.goods_id;
					if(!honey.goodsDetail){
						honey.goodsDetail=plus.webview.currentWebview();
					}
					honey.goodsDetail.setStyle({
						mask: "none"
					})
					if(!honey.imageSliderView){
						var data={
							top:'0px',
							left:'0px',
							height:'220px',
							width:'100%',
							position:'static',
							images:[{src:'../images/default.png'}]
						};
						honey.imageSliderView = new plus.nativeObj.ImageSlider('test',data);
						honey.goodsDetail.append(honey.imageSliderView);
					}else{
						honey.imageSliderView.setImages([{src:'../images/default.png'}]);
					}
					mySrcollTo()
					honey.d.evaluateList.innerHTML='';
					honey.d.content.innerHTML='';
					honey.d.buyNum.value=1;
					honey.collectCallBack()
					honey.ajaxGetData()
					honey.goodsDetail.show()
				})
				
				/**
				 * 滚动事件
				 */
				document.addEventListener('scroll',function(){
					if(honey.scrollMenu){
						honey.scrollMenu=false;
						var h1=window.innerHeight;
						var h=document.body.scrollTop+220;
						var s1=honey.d.goodsContent.offsetTop;
						var s2=honey.d.evaluate.offsetTop;
						var i=0;
						if(h>=s2){
							i=2;
						}else if(h>=s1){
							i=1;
						}
						honey.d.topMenu.className='';
						honey.d.topMenu=honey.d.topSpan[i];
						honey.d.topMenu.className="active";
						if((h+220)>h1){
							honey.d.header.setAttribute('style','')
						}else{
							honey.d.header.setAttribute('style','display:none')
						}
						setTimeout(function(){
							honey.scrollMenu=true;
						},200)
					}
				})
			})
			
			
		</script>
	</body>

</html>